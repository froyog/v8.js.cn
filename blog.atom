<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>V8</title>
  <subtitle>JavaScript V8 å¼•æ“</subtitle>
  <link href="https://v8.js.cn/blog.atom" rel="self"/>
  <link href="https://v8.js.cn/"/>
  <updated>2015-07-10T13:33:37+00:00</updated>
  <id>https://v8.js.cn/</id>
  <author>
    <name>Mathias Bynens</name>
  </author>
  
  <entry>
    <title>æ›´å¿«çš„å¼‚æ­¥å‡½æ•°å’Œ Promise</title>
    <link href="https://v8.js.cn/blog/fast-async"/>
    <updated>2018-11-12T16:45:07+00:00</updated>
    <id>https://v8.js.cn/blog/fast-async</id>
    <author>
      <name>Maya Lekova (@MayaLekova), always-awaiting anticipator, and Benedikt Meurer (@bmeurer), professional performance promiser</name>
    </author>
    <content type="html">&lt;p&gt;JavaScript ä¸­çš„å¼‚æ­¥å¤„ç†å†æ¥å› å…¶ä¸æ˜¯ç‰¹åˆ«å¿«è€Œé—»åï¼ˆ:pï¼‰ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè°ƒè¯•å®æ—¶ JavaScript åº”ç”¨ç¨‹åº - ä¾‹å¦‚ Node.js æœåŠ¡å™¨ - å¹¶éæ˜“äº‹ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°å¼‚æ­¥ç¼–ç¨‹æ—¶æ›´ç”šã€‚å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨æœ‰äº†ä¸€ä¸ªé‡å¤§çš„æ”¹å˜ã€‚æœ¬æ–‡æ¢è®¨äº†æˆ‘ä»¬å¦‚ä½•åœ¨ V8ï¼ˆç”šè‡³å…¶å®ƒ JavaScript å¼•æ“ä¸­ï¼‰ä¸­ä¼˜åŒ–å¼‚æ­¥å‡½æ•°å’Œ promiseï¼Œå¹¶æè¿°äº†æˆ‘ä»¬å¦‚ä½•æ”¹è¿›å¼‚æ­¥ä»£ç çš„è°ƒè¯•ä½“éªŒã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼šå¦‚æœæ‚¨æ›´å–œæ¬¢è§‚çœ‹æ¼”ç¤ºæ–‡ç¨¿ï¼Œè¯·æ¬£èµä¸‹é¢çš„è§†é¢‘ï¼å¦‚æœæ²¡æœ‰ï¼Œè¯·è·³è¿‡è§†é¢‘å¹¶ç»§ç»­é˜…è¯»ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/DFP5DKDQfOc&quot; width=&quot;640&quot; height=&quot;360&quot;&gt;&lt;/iframe&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;a-new-approach-to-async-programming&quot;&gt;ä¸€ç§æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ³• &lt;a class=&quot;bookmark&quot; href=&quot;#a-new-approach-to-async-programming&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;from-callbacks-to-promises-to-async-functions&quot;&gt;ä»å›è°ƒåˆ° Promise åˆ°å¼‚æ­¥å‡½æ•° &lt;a class=&quot;bookmark&quot; href=&quot;#from-callbacks-to-promises-to-async-functions&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;åœ¨ promise è¢«åŠ å…¥åˆ° JavaScript è¯­è¨€ä¹‹å‰ï¼Œå¼‚æ­¥ä»£ç ä¸€èˆ¬ä½¿ç”¨åŸºäºå›è°ƒçš„ APIï¼Œå°¤å…¶æ˜¯åœ¨ Node.js ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;done&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token function&quot;&gt;validateParams&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token function&quot;&gt;dbQuery&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dbResults&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      &lt;span class=&quot;token function&quot;&gt;serviceCall&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dbResults&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; serviceResults&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;        console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;        &lt;span class=&quot;token function&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; serviceResults&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å½“åµŒå¥—å›è°ƒå˜çš„è¶Šæ¥è¶Šæ·±ä»¥åï¼Œæˆ‘ä»¬ç§°è¿™ç§æ¨¡å¼ä¸ºâ€œå›è°ƒåœ°ç‹±â€ï¼Œå› ä¸ºå®ƒä½¿ä»£ç ä¸æ˜“è¯»å–ä¸”éš¾ä»¥ç»´æŠ¤ã€‚&lt;/p&gt;
&lt;p&gt;å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨ promise æˆäº† JavaScript è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œç›¸åŒçš„ä»£ç å¯ä»¥ä»¥æ›´ä¼˜é›…å’Œå¯ç»´æŠ¤çš„æ–¹å¼ç¼–å†™ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateParams&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dbQuery&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;serviceCall&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æœ€è¿‘ï¼ŒJavaScript å¼€å§‹æ”¯æŒäº† &lt;a href=&quot;https://developers.google.com/web/fundamentals/primers/async-functions&quot;&gt;å¼‚æ­¥å‡½æ•°&lt;/a&gt;ã€‚ç°åœ¨å¯ä»¥ç”¨ä¸åŒæ­¥ä»£ç éå¸¸ç›¸ä¼¼çš„æ–¹å¼ç¼–å†™ä¸Šè¿°å¼‚æ­¥ä»£ç ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;validateParams&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dbResults &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;dbQuery&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; results &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;serviceCall&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dbResults&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Œä»£ç å˜å¾—æ›´åŠ ç®€æ´ï¼Œå¹¶ä¸”æ•°æ®æµæ›´å®¹æ˜“æ§åˆ¶ï¼Œå°½ç®¡æ‰§è¡Œä»ç„¶æ˜¯å¼‚æ­¥çš„ã€‚ï¼ˆè¯·æ³¨æ„ï¼ŒJavaScript æ‰§è¡Œä»ç„¶å‘ç”Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè¿™æ„å‘³ç€å¼‚æ­¥å‡½æ•°æœ¬èº«ä¸ä¼šåˆ›å»ºçœŸå®çš„ç‰©ç†çº¿ç¨‹ã€‚ï¼‰&lt;/p&gt;
&lt;h3 id=&quot;from-event-listener-callbacks-to-async-iteration&quot;&gt;ä»äº‹ä»¶ç›‘å¬å›è°ƒåˆ°å¼‚æ­¥è¿­ä»£å™¨ &lt;a class=&quot;bookmark&quot; href=&quot;#from-event-listener-callbacks-to-async-iteration&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;å¦ä¸€ä¸ªåœ¨ Node.js ä¸­ç‰¹åˆ«å¸¸è§çš„å¼‚æ­¥èŒƒä¾‹æ˜¯ &lt;a href=&quot;https://nodejs.org/api/stream.html#stream_readable_streams&quot;&gt;&lt;code&gt;ReadableStream&lt;/code&gt;&lt;/a&gt;ã€‚è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; http &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;http&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createServer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; body &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setEncoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;utf8&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;data&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;chunk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    body &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; chunk&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1337&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿™æ®µä»£ç æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼šä¼ å…¥çš„æ•°æ®åªèƒ½åœ¨å›è°ƒå‡½æ•°ä¸­ä»¥ chunks çš„æ–¹å¼å¤„ç†ï¼Œå¹¶ä¸”æµçš„ç»“æŸä¿¡å·ä¹Ÿåœ¨å›è°ƒå‡½æ•°å†…å‘ç”Ÿã€‚å¦‚æœä½ æ²¡æœ‰æ„è¯†åˆ°å‡½æ•°å…¶å®å·²ç»ç«‹å³ç»ˆæ­¢äº†ï¼Œå¹¶ä¸”å¿…é¡»åœ¨å›è°ƒå‡½æ•°ä¸­è¿›è¡Œå®é™…å¤„ç†ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“åœ¨è¿™é‡Œå¼•å…¥é”™è¯¯ã€‚&lt;/p&gt;
&lt;p&gt;å¹¸è¿çš„æ˜¯ï¼Œä¸€ä¸ªå¾ˆé…·çš„æ–°çš„ ES2018 ç‰¹æ€§&lt;a href=&quot;http://2ality.com/2016/10/asynchronous-iteration.html&quot;&gt;å¼‚æ­¥è¿­ä»£å™¨ async iteration&lt;/a&gt; å¯ä»¥ç®€åŒ–æ­¤ä»£ç ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; http &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;http&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createServer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; body &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setEncoding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;utf8&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; chunk &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;      body &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; chunk&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;statusCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1337&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦å°†å®é™…å¤„ç†çš„é€»è¾‘åˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªä¸åŒçš„å›è°ƒå‡½æ•°ä¸­ - &lt;code&gt;&#39;data&#39;&lt;/code&gt; å’Œ &lt;code&gt;&#39;end&#39;&lt;/code&gt;ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›éƒ½å†™æˆä¸€ä¸ªå•ä¸€çš„å¼‚æ­¥å‡½æ•°æ¥å¤„ç†ï¼Œå¹¶ä½¿ç”¨æ–°çš„ &lt;code&gt;for awaitâ€¦of&lt;/code&gt; å¾ªç¯æ¥å¼‚æ­¥çš„éå†æ•°æ®å—ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº† &lt;code&gt;try-catch&lt;/code&gt; å—æ¥é˜²æ­¢å‡ºç° &#39;unhandledRejection&#39; å¼‚å¸¸&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨å·²ç»å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è¿™äº›æ–°å‡½æ•°äº†ï¼ä» &lt;strong&gt;Node.js 8ï¼ˆV8 v6.2 / Chrome 62ï¼‰å¼€å§‹å·²ç»å®Œå…¨æ”¯æŒ&lt;/strong&gt;å¼‚æ­¥å‡½æ•°ï¼Œå¹¶ä¸”ä» &lt;strong&gt;Node.js 10ï¼ˆV8 v6.8 / Chrome 68ï¼‰å¼€å§‹å·²ç»å®Œå…¨æ”¯æŒ&lt;/strong&gt;å¼‚æ­¥è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ï¼&lt;/p&gt;
&lt;h2 id=&quot;async-performance-improvements&quot;&gt;å¼‚æ­¥æ€§èƒ½æ”¹è¿› &lt;a class=&quot;bookmark&quot; href=&quot;#async-performance-improvements&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å·²ç»æˆåŠŸåœ°åœ¨ V8 v5.5ï¼ˆChrome 55 å’Œ Node.js 7ï¼‰å’Œ V8 v6.8ï¼ˆChrome 68 å’Œ Node.js 10ï¼‰ä¹‹é—´æ˜¾ç€æé«˜äº†å¼‚æ­¥ä»£ç çš„æ€§èƒ½ã€‚æˆ‘ä»¬å·²ç»ä½¿å¼•æ“è¾¾åˆ°äº†ä¸€å®šçš„æ€§èƒ½æ°´å¹³ï¼Œä»¥ä¾¿å¼€å‘è€…å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™äº›æ–°çš„ç¼–ç¨‹èŒƒä¾‹ï¼Œè€Œæ— éœ€æ‹…å¿ƒé€Ÿåº¦ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/doxbee-benchmark.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯ &lt;a href=&quot;https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js&quot;&gt;doxbee benchmark&lt;/a&gt;ï¼Œå®ƒè¯„ä¼°äº† Promise çš„æ€§èƒ½ã€‚è¯·æ³¨æ„ï¼Œå›¾è¡¨ä¸­çš„æ‰§è¡Œæ—¶é—´è¶Šä½æ„å‘³ç€æ€§èƒ½è¶Šå¥½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js&quot;&gt;parallel benchmark&lt;/a&gt; çš„ç»“æœåˆ™æ›´åŠ å¼ºè°ƒäº† &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all&quot;&gt;&lt;code&gt;Promise.all()&lt;/code&gt;&lt;/a&gt; çš„æ€§èƒ½ï¼Œæ›´ä»¤äººå…´å¥‹ï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/parallel-benchmark.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æˆ‘ä»¬è®¾æ³•å°† &lt;code&gt;Promise.all&lt;/code&gt; çš„æ€§èƒ½æé«˜äº† &lt;strong&gt;8&lt;/strong&gt; å€ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œä¸Šè¿°åŸºå‡†æµ‹è¯•æ˜¯è·‘åˆ†æµ‹è¯•ï¼ˆsynthetic micro-benchmarksï¼‰ã€‚V8 å›¢é˜Ÿå¯¹&lt;a href=&quot;https://v8.js.cn/blog/real-world-performance&quot;&gt;çœŸå®ä¸–ç•Œçš„å®é™…ç”¨æˆ·ä»£ç æ€§èƒ½&lt;/a&gt;æ›´æ„Ÿå…´è¶£ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/http-benchmarks.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;ä¸Šé¢çš„å›¾è¡¨å±•ç¤ºäº†ä¸€äº›æµè¡Œçš„ HTTP ä¸­é—´ä»¶åŠæ¡†æ¶çš„æ€§èƒ½ï¼Œè¿™äº›æ¡†æ¶å¤§é‡ä½¿ç”¨äº† Promise å’Œ &lt;code&gt;async&lt;/code&gt; å‡½æ•°ã€‚è¯·æ³¨æ„ï¼Œæ­¤å›¾è¡¨æ˜¾ç¤ºäº†æ¯ç§’çš„è¯·æ±‚æ•°ï¼ˆrequests/secondï¼‰ï¼Œå› æ­¤ä¸ä¹‹å‰çš„å›¾è¡¨ä¸åŒï¼Œè¿™ä¸ªå›¾è¡¨ä¸­ï¼ŒæŸ±çŠ¶å›¾è¶Šé«˜è¡¨ç¤ºè¶Šå¥½ã€‚è¿™äº›æ¡†æ¶çš„æ€§èƒ½åœ¨ Node.js 7ï¼ˆV8 v5.5ï¼‰å’Œ Node.js 10ï¼ˆV8 v6.8ï¼‰ä¹‹é—´å¾—åˆ°äº†æ˜¾ç€æå‡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™äº›æ€§èƒ½æ”¹è¿›ä¸»è¦å¾—ç›Šäºä»¥ä¸‹ä¸‰é¡¹å…³é”®æˆæœï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://v8.js.cn/docs/turbofan&quot;&gt;TurboFan&lt;/a&gt;ï¼Œæ–°çš„ä¼˜åŒ–ç¼–è¯‘å™¨ ğŸ‰&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://v8.js.cn/blog/orinoco&quot;&gt;Orinoco&lt;/a&gt;ï¼Œæ–°çš„åƒåœ¾æ”¶é›†å™¨ ğŸš›&lt;/li&gt;
&lt;li&gt;Node.js 8 çš„ bugï¼Œ&lt;code&gt;await&lt;/code&gt; è·³è¿‡ microticks ğŸ›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“æˆ‘ä»¬åœ¨ &lt;a href=&quot;https://medium.com/the-node-js-collection/node-js-8-3-0-is-now-available-shipping-with-the-ignition-turbofan-execution-pipeline-aa5875ad3367&quot;&gt;Node.js 8&lt;/a&gt; ä¸­&lt;a href=&quot;https://v8.js.cn/blog/launching-ignition-and-turbofan&quot;&gt;æ¨å‡ºTurboFan&lt;/a&gt; æ—¶ï¼Œå…¨é¢æå‡äº†æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶ä¸€ç§æ–°çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º Orinocoï¼Œå®ƒå¯ä»¥å°†åƒåœ¾æ”¶é›†å·¥ä½œä»ä¸»çº¿ç¨‹ä¸­ç§»é™¤ï¼Œä»è€Œæ˜¾ç€æ”¹å–„äº†åƒåœ¾æ”¶é›†çš„è¯·æ±‚å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œè™½ç„¶æ”¾åœ¨åé¢ä½†æ˜¯å¹¶éä¸é‡è¦ï¼ŒNode.js 8 ä¸­æœ‰ä¸€ä¸ª bug å¯¼è‡´ &lt;code&gt;await&lt;/code&gt; åœ¨æŸäº›æƒ…å†µä¸‹è·³è¿‡ microticksï¼Œä»è€Œäº§ç”Ÿæ›´å¥½çš„æ€§èƒ½ã€‚è¿™ä¸ª bug çš„åŸå› æ˜¯æˆ‘ä»¬è¿åäº† es çš„è§„èŒƒï¼Œä½†å®ƒåæ¥ç»™äº†æˆ‘ä»¬å…³äºä¼˜åŒ–çš„çµæ„Ÿã€‚è®©æˆ‘ä»¬ä»æœ‰ç¼ºé™·çš„è¡Œä¸ºå¼€å§‹ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Promise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;after:await&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;tick:a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;tick:b&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸Šé¢çš„ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ªçŠ¶æ€ä¸º fulfilled çš„ Promiseï¼š&lt;code&gt;p&lt;/code&gt;ï¼Œç„¶å &lt;code&gt;await&lt;/code&gt; å–å¾—å®ƒçš„ç»“æœï¼Œä¸æ­¤åŒæ—¶ä¹Ÿå°†åé¢çš„ 2 ä¸ª &lt;code&gt;then&lt;/code&gt; å‡½æ•°å¤„ç†ç¨‹åºé“¾æ¥åˆ°å®ƒä¸Šé¢ã€‚æ‚¨å¸Œæœ›ä»¥å“ªç§é¡ºåºæ‰§è¡Œ &lt;code&gt;console.log&lt;/code&gt; è°ƒç”¨å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ—¢ç„¶ &lt;code&gt;p&lt;/code&gt; çš„çŠ¶æ€å·²ç»æ˜¯ fulfilled äº†ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºé¦–å…ˆæ‰“å° &lt;code&gt;&#39;after:await&#39;&lt;/code&gt; ç„¶åå†æ‰“å° &lt;code&gt;&#39;tick&#39;&lt;/code&gt;ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯ Node.js 8 ä¸­çš„è¡Œä¸ºï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-bug-node-8.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Node.js 8 çš„ &lt;code&gt;await&lt;/code&gt; bug&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;è™½ç„¶è¿™ç§è¡Œä¸ºçœ‹èµ·æ¥å¾ˆç›´è§‚ï¼Œä½†æ ¹æ®è§„èŒƒå®ƒå¹¶ä¸æ­£ç¡®ã€‚Node.js 10 å®ç°äº†æ­£ç¡®çš„è¡Œä¸ºï¼Œå³é¦–å…ˆæ‰§è¡Œé“¾å¼å¤„ç†ç¨‹åºï¼Œç„¶åç»§ç»­ä½¿ç”¨å¼‚æ­¥å‡½æ•°ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-bug-node-10.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Node.js 10 ä¸­ä¸å†æœ‰ &lt;code&gt;await&lt;/code&gt; çš„ bug&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;å¯ä»¥è¯´ï¼Œè¿™ç§â€œæ­£ç¡®çš„è¡Œä¸ºâ€å…¶å®å¹¶ä¸ç›´è§‚ï¼Œå¯¹ JavaScript å¼€å‘è€…æ¥è¯´å®é™…ä¸Šæ˜¯ä»¤äººæƒŠè®¶çš„ï¼Œæ‰€ä»¥å€¼å¾—åšä¸€äº›è§£é‡Šã€‚åœ¨æˆ‘ä»¬æ·±å…¥äº†è§£ Promise å’Œå¼‚æ­¥å‡½æ•°çš„ç¥å¥‡ä¹‹å¤„å‰ï¼Œè®©æˆ‘ä»¬ä»ä¸€äº›æ›´åŠ åŸºç¡€çš„æƒ…å†µå¼€å§‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;tasks-vs.-microtasks&quot;&gt;Tasks vs. microtasks &lt;a class=&quot;bookmark&quot; href=&quot;#tasks-vs.-microtasks&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;åœ¨é«˜å±‚æ¬¡ä¸Šï¼ŒJavaScript ä¸­æœ‰ &lt;em&gt;task&lt;/em&gt; å’Œ &lt;em&gt;microtask&lt;/em&gt;ã€‚task ç”¨äºå¤„ç† I/O å’Œè®¡æ—¶å™¨ç­‰äº‹ä»¶ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€ä¸ªã€‚microtask ä¸º &lt;code&gt;async&lt;/code&gt;/&lt;code&gt;await&lt;/code&gt; å’Œ Promise å®ç°å»¶è¿Ÿæ‰§è¡Œï¼Œå¹¶åœ¨æ¯ä¸ª task ç»“æŸæ—¶æ‰§è¡Œã€‚åœ¨æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œmicrotask é˜Ÿåˆ—æ€»æ˜¯è¢«æ¸…ç©ºï¼ˆæ‰§è¡Œï¼‰ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/microtasks-vs-tasks.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;å¾®ä»»åŠ¡å’Œä»»åŠ¡ä¹‹é—´çš„åŒºåˆ«&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ Jake Archibald å¯¹&lt;a href=&quot;https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/&quot;&gt;æµè§ˆå™¨ä¸­çš„ tasksã€microtasksã€queues ä¸ schedules&lt;/a&gt; ï¼ˆ&lt;a href=&quot;https://hongfanqie.github.io/tasks-microtasks-queues-and-schedules/&quot;&gt;ä¸­æ–‡ç¿»è¯‘&lt;/a&gt;ï¼‰çš„è§£é‡Šã€‚Node.js ä¸­çš„ä»»åŠ¡æ¨¡å‹ä¸æ­¤éå¸¸ç›¸ä¼¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;async-functions&quot;&gt;å¼‚æ­¥å‡½æ•° &lt;a class=&quot;bookmark&quot; href=&quot;#async-functions&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;æ ¹æ® MDNï¼Œå¼‚æ­¥å‡½æ•°æ˜¯ä¸€ä¸ªä½¿ç”¨éšå¼ Promise å¼‚æ­¥æ“ä½œä»¥è¿”å›å…¶ç»“æœçš„å‡½æ•°ã€‚å¼‚æ­¥å‡½æ•°æ—¨åœ¨ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œä¸ºå¼€å‘è€…éšè—å¼‚æ­¥å¤„ç†çš„ä¸€äº›å¤æ‚æ€§ã€‚&lt;/p&gt;
&lt;p&gt;æœ€ç®€å•çš„å¼‚æ­¥å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;computeAnswer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å½“è¿™ä¸ªå¼‚æ­¥å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ª Promiseï¼Œä½ å¯ä»¥åƒä»»ä½•å…¶ä»–çš„ Promise é‚£æ ·è·å¾—å®ƒçš„å€¼ã€‚&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;computeAnswer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ Promise&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;log&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// prints 42 on the next turn&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åªæœ‰ &lt;code&gt;p&lt;/code&gt; åœ¨ä¸‹æ¬¡è¿è¡Œ microtask æ—¶æ‰èƒ½è·å¾—æ­¤ Promise çš„å€¼ã€‚æ¢å¥è¯è¯´ï¼Œä¸Šé¢çš„ç¨‹åºåœ¨è¯­ä¹‰ä¸Šç­‰åŒäºå¯¹å€¼è°ƒç”¨ &lt;code&gt;Promise.resolve&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;computeAnswer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; Promise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¼‚æ­¥å‡½æ•°çš„çœŸæ­£å¨åŠ›æ¥è‡ª &lt;code&gt;await&lt;/code&gt; è¡¨è¾¾å¼ï¼Œå®ƒä¼šæš‚åœå‡½æ•°çš„æ‰§è¡Œç›´åˆ° Promise çŠ¶æ€å˜ä¸º resolvedï¼Œå¹¶åœ¨æ‰§è¡Œåæ¢å¤ã€‚&lt;code&gt;await&lt;/code&gt; çš„å€¼æ˜¯ Promise è¢« fulfilled çš„å€¼ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetchStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; response &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;await&lt;/code&gt; æš‚åœäº†å‡½æ•° &lt;code&gt;fetchStatus&lt;/code&gt; çš„æ‰§è¡Œï¼Œç¨ååœ¨ &lt;code&gt;fetch&lt;/code&gt; è¿”å›çš„ Promise çŠ¶æ€å˜ä¸º fulfilled æ—¶æ¢å¤äº†æ‰§è¡Œã€‚è¿™æˆ–å¤šæˆ–å°‘ç­‰åŒäºå°†æŠŠå¤„ç†è¿‡ç¨‹å†™åœ¨ &lt;code&gt;fetch&lt;/code&gt; è¿”å› Promise çš„ &lt;code&gt;then&lt;/code&gt; é“¾ã€‚&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetchStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;response &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¯¥å¤„ç†ç¨‹åºåœ¨å¼‚æ­¥å‡½æ•°ç§åŒ…å«äº† &lt;code&gt;await&lt;/code&gt; ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸ä½ ä¼šä¼ é€’ &lt;code&gt;Promise&lt;/code&gt; ç»™ &lt;code&gt;await&lt;/code&gt;ï¼Œä½†ä½ å®é™…ä¸Šå¯ä»¥ç­‰å¾…ï¼ˆawaitï¼‰ä»»æ„çš„ JavaScript å€¼ã€‚å¦‚æœ &lt;code&gt;await&lt;/code&gt; åé¢çš„è¡¨è¾¾å¼çš„å€¼ä¸æ˜¯ Promiseï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º Promiseã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥è¿™æ ·å†™ &lt;code&gt;await 42&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ Promise&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;log&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// prints `42` eventually&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ›´æœ‰è¶£çš„æ˜¯ï¼Œ&lt;code&gt;await&lt;/code&gt; å¯ä»¥ä½¿ç”¨ä»»ä½• &lt;a href=&quot;https://promisesaplus.com/&quot;&gt;â€œthenableâ€&lt;/a&gt;ï¼Œå³ä»»ä½•å¸¦æœ‰ &lt;code&gt;then&lt;/code&gt; æ–¹æ³•çš„å¯¹è±¡ï¼Œå³ä½¿å®ƒä¸æ˜¯çœŸæ­£çš„ Promiseã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å®ç°æœ‰è¶£çš„äº‹æƒ…ï¼Œä¾‹å¦‚æµ‹é‡å®é™… sleep æ—¶é—´çš„å¼‚æ­¥ sleep åŠŸèƒ½ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Sleep&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeout&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timeout&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token function&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; startTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Date&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; startTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;               &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeout&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; actualTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;actualTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ V8 å¼•æ“åº•å±‚æ˜¯å¦‚ä½•å®ç° &lt;code&gt;await&lt;/code&gt; &lt;a href=&quot;https://tc39.github.io/ecma262/#await&quot;&gt;è§„èŒƒ&lt;/a&gt;çš„ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æ­¥å‡½æ•° &lt;code&gt;foo&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; w &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; w&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°†å‚æ•° &lt;code&gt;v&lt;/code&gt; åŒ…è£…ä¸º Promise å¹¶æš‚åœæ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œç›´åˆ°è¯¥ Promise çš„çŠ¶æ€å˜ä¸º resolvedã€‚ä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå‡½æ•°çš„æ‰§è¡Œå°†æ¢å¤å¹¶ä¸”è¿™ä¸ª fulfilled çš„ Promise çš„å€¼è¢«èµ‹å€¼ç»™ &lt;code&gt;w&lt;/code&gt;ã€‚ç„¶åä»å¼‚æ­¥å‡½æ•°ä¸­è¿”å›æ­¤å€¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;await-under-the-hood&quot;&gt;å¼•æ“åº•å±‚çš„ &lt;code&gt;await&lt;/code&gt; &lt;a class=&quot;bookmark&quot; href=&quot;#await-under-the-hood&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;é¦–å…ˆï¼ŒV8 å°†æ­¤å‡½æ•°æ ‡è®°ä¸ºå¯æ¢å¤ï¼ˆ&lt;em&gt;resumable&lt;/em&gt;ï¼‰ï¼Œè¿™æ„å‘³ç€å¯ä»¥æš‚åœæ‰§è¡Œå¹¶ç¨åæ¢å¤æ‰§è¡Œï¼ˆåœ¨ &lt;code&gt;await&lt;/code&gt; å¤„ï¼‰ã€‚ç„¶åå®ƒåˆ›å»ºæ‰€è°“çš„ &lt;code&gt;implicit_promise&lt;/code&gt;ï¼ˆéšå¼ Promiseï¼‰ï¼Œè¿™æ˜¯åœ¨è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶è¿”å›çš„ Promiseï¼Œå¹¶æœ€ç»ˆè§£æï¼ˆresolveï¼‰ä¸ºå¼‚æ­¥å‡½æ•°ç”Ÿæˆçš„å€¼ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-under-the-hood.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;ç®€å•çš„å¼‚æ­¥å‡½æ•°ä¸å¼•æ“è½¬æ¢ä¹‹åçš„ä»£ç ä¹‹é—´çš„æ¯”è¾ƒ&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;ç„¶åæ˜¯æœ‰è¶£çš„ä¸€ç‚¹ï¼šå®é™…çš„ &lt;code&gt;await&lt;/code&gt;ã€‚é¦–å…ˆï¼Œä¼ é€’ç»™ &lt;code&gt;await&lt;/code&gt; çš„å€¼è¢«åŒ…è£¹åœ¨ä¸€ä¸ª Promise ä¸­ã€‚ç„¶åï¼Œå¤„ç†ç¨‹åºé™„åŠ åˆ°è¿™ä¸ªåŒ…è£…çš„ Promiseï¼Œä»¥ä¾¿åœ¨ Promise å˜ä¸º fulfilled åæ¢å¤è¯¥å‡½æ•°ï¼Œå¹¶ä¸”æš‚åœæ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå¹¶å°† &lt;code&gt;implicit_promise&lt;/code&gt; è¿”å›ç»™è°ƒç”¨è€…ã€‚ä¸€æ—¦ &lt;code&gt;promise&lt;/code&gt; å˜ä¸º fulfilledï¼Œæ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶å°† &lt;code&gt;promise&lt;/code&gt; çš„å€¼èµ‹å€¼ç»™ &lt;code&gt;w&lt;/code&gt;ï¼Œè€Œä¸”è¿™ä¸ª &lt;code&gt;w&lt;/code&gt; ä¹Ÿæ˜¯ &lt;code&gt;implicit_promise&lt;/code&gt; è¢« resolved åçš„å€¼ã€‚&lt;/p&gt;
&lt;p&gt;ç®€è€Œè¨€ä¹‹ï¼Œ&lt;code&gt;await v&lt;/code&gt; çš„æœ€åˆçš„æ‰§è¡Œæ­¥éª¤æ˜¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å°† &lt;code&gt;v&lt;/code&gt; è½¬æ¢ä¸º Promise- &lt;code&gt;v&lt;/code&gt; ä»£è¡¨ä¼ é€’ç»™ &lt;code&gt;await&lt;/code&gt; çš„å€¼ã€‚&lt;/li&gt;
&lt;li&gt;ç»™ Promise é™„åŠ å¤„ç†ç¨‹åºä»¥ä¾¿ç¨åæ¢å¤å¼‚æ­¥å‡½æ•°ã€‚&lt;/li&gt;
&lt;li&gt;æŒ‚èµ·å¼‚æ­¥å‡½æ•°å¹¶è¿”å› &lt;code&gt;implicit_promise&lt;/code&gt; ç»™è°ƒç”¨è€…ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°å®Œæˆå„ä¸ªæ“ä½œã€‚å‡è®¾ä¼ é€’ç»™ &lt;code&gt;await&lt;/code&gt; çš„å†…å®¹å·²ç»æ˜¯ä¸€ä¸ª Promiseï¼Œè€Œå®ƒçš„ fulfilled çš„å€¼æ˜¯ &lt;code&gt;42&lt;/code&gt;ã€‚éšå V8 å¼•æ“åˆåˆ›å»ºä¸€ä¸ªæ–°çš„ &lt;code&gt;promise&lt;/code&gt; å¹¶å¯¹ &lt;code&gt;await&lt;/code&gt; åé¢çš„ Promise æ‰§è¡Œ resolve æ“ä½œä»è€Œå–å‡ºå€¼ã€‚è¿™ç¡®å®æ¨è¿Ÿäº†ä¸‹ä¸€è½®çš„ Promise å¤„ç†é“¾ï¼Œè¿™äº›è¢«å®šä¹‰åœ¨è§„èŒƒä¸­çš„ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob&quot;&gt;&lt;code&gt;PromiseResolveThenableJob&lt;/code&gt;&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-step-1.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;ç„¶åå¼•æ“åˆ›é€ äº†å¦ä¸€ä¸ªæ‰€è°“çš„ &lt;code&gt;throwaway&lt;/code&gt; Promiseã€‚å®ƒè¢«ç§°ä¸º &lt;em&gt;throwaway&lt;/em&gt;ï¼Œå› ä¸ºå®ƒçš„ &lt;code&gt;then&lt;/code&gt; é“¾æ²¡æœ‰ä»»ä½•å¤„ç†ç¨‹åº - å®ƒå®Œå…¨åœ¨å¼•æ“å†…éƒ¨ã€‚æ­¤ &lt;code&gt;throwaway&lt;/code&gt; ç„¶åè¢«é“¾æ¥åˆ° &lt;code&gt;promise&lt;/code&gt;ï¼Œä½¿ç”¨é€‚å½“çš„å¤„ç†ç¨‹åºæ¥æ¢å¤å¼‚æ­¥å‡½æ•°ã€‚è¿™ä¸ª &lt;code&gt;performPromiseThen&lt;/code&gt; æ“ä½œåŸºæœ¬ä¸Šå°±æ˜¯ &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then&quot;&gt;&lt;code&gt;Promise.prototype.then()&lt;/code&gt;&lt;/a&gt; çš„å¹•åæ“ä½œã€‚æœ€åï¼Œæš‚åœæ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå¹¶ä¸”æ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨è€…ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-step-2.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;è°ƒç”¨è€…ç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒç”¨æ ˆå˜ç©ºã€‚ç„¶å JavaScript å¼•æ“å¼€å§‹è¿è¡Œ microtaskï¼šå®ƒè¿è¡Œä¹‹å‰å®‰æ’çš„è®¡åˆ’ä»»åŠ¡ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob&quot;&gt;&lt;code&gt;PromiseResolveThenableJob&lt;/code&gt;&lt;/a&gt;ï¼Œè¯¥è®¡åˆ’ä»»åŠ¡åˆå®‰æ’äº†æ–°çš„ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promisereactionjob&quot;&gt;&lt;code&gt;PromiseReactionJob&lt;/code&gt;&lt;/a&gt;ï¼Œä½œä¸º &lt;code&gt;await&lt;/code&gt; ä¹‹åçš„ Promise çš„å¤„ç†é“¾ã€‚ç„¶åï¼Œå¼•æ“è¿”å›å¹¶å¤„ç† microtask é˜Ÿåˆ—ï¼Œå› ä¸ºåœ¨ç»§ç»­ä¸»äº‹ä»¶å¾ªç¯ä¹‹å‰å¿…é¡»æ¸…ç©º microtask é˜Ÿåˆ—ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-step-3.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æ¥ä¸‹æ¥æ˜¯ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promisereactionjob&quot;&gt;&lt;code&gt;PromiseReactionJob&lt;/code&gt;&lt;/a&gt;ï¼Œå®ƒå°† &lt;code&gt;promise&lt;/code&gt; è®¾ç½®ä¸ºçŠ¶æ€ fulfilledï¼Œå…¶å€¼æ˜¯æˆ‘ä»¬æ­£åœ¨ &lt;code&gt;await&lt;/code&gt; çš„ Promise å€¼ - åœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ &lt;code&gt;42&lt;/code&gt; - å¹¶ä¸”å°†è®¡åˆ’ä»»åŠ¡é“¾åˆ° &lt;code&gt;throwaway&lt;/code&gt; Promiseã€‚ç„¶åå¼•æ“å†æ¬¡è¿”å› microtask å¾ªç¯ï¼Œå…¶ä¸­åŒ…å«è¦å¤„ç†çš„æœ€ç»ˆ microtaskã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-step-4-final.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;ç°åœ¨è¿™ç¬¬äºŒä¸ª &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promisereactionjob&quot;&gt;&lt;code&gt;PromiseReactionJob&lt;/code&gt;&lt;/a&gt; å°† resove çš„å€¼ä¼ æ’­åˆ° &lt;code&gt;throwaway&lt;/code&gt; promiseï¼Œå¹¶æ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œ&lt;code&gt;await&lt;/code&gt; çš„è¿”å›å€¼ä¸º &lt;code&gt;42&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-overhead.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;&lt;code&gt;await&lt;/code&gt; çš„å¼€é”€&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;æ€»ç»“ä¸€ä¸‹ï¼Œæ¯ä¸ª &lt;code&gt;await&lt;/code&gt; å¼•æ“å¿…é¡»åˆ›å»º&lt;strong&gt;ä¸¤ä¸ªé¢å¤–&lt;/strong&gt;çš„ Promiseï¼ˆå³ä½¿å³ä¾§å·²ç»æ˜¯ä¸€ä¸ª Promisï¼‰å¹¶ä¸”å®ƒéœ€è¦&lt;strong&gt;è‡³å°‘ä¸‰ä¸ª&lt;/strong&gt; microtask é˜Ÿåˆ— ticksã€‚è°ä¼šæ„è¯†åˆ°ä»…ä»…æ˜¯ä¸€ä¸ª &lt;code&gt;await&lt;/code&gt; è¡¨è¾¾å°±å¯¼è‡´äº†å¦‚æ­¤ä¹‹å¤šçš„å¼€é”€ï¼Ÿï¼&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-code-before.svg&quot; alt=&quot;&quot; width=&quot;400&quot; height=&quot;191&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›å¼€é”€æ¥è‡ªå“ªé‡Œã€‚ç¬¬ä¸€è¡Œåˆ›å»ºäº† Promise åŒ…è£…å™¨ã€‚ç¬¬äºŒè¡Œç«‹å³ä½¿ç”¨ &lt;code&gt;await&lt;/code&gt; è§£æ Promise åŒ…è£…å™¨ &lt;code&gt;v&lt;/code&gt; çš„å€¼ã€‚è¿™ä¸¤è¡Œå¯¼è‡´äº†å¦å¤–ä¸€ä¸ªé¢å¤–çš„ Promise å’Œä¸‰ä¸ª microtick ä¸­çš„ä¸¤ä¸ªã€‚å¦‚æœ &lt;code&gt;v&lt;/code&gt; å·²ç»æ˜¯ä¸€ä¸ª Promiseï¼ˆè¿™æ˜¯å¸¸è§çš„æƒ…å†µï¼Œå› ä¸ºåº”ç”¨ç¨‹åºé€šå¸¸ä¼šåœ¨ Promise ä¸Šè°ƒç”¨ &lt;code&gt;await&lt;/code&gt;ï¼‰ï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„ã€‚åœ¨å¼€å‘è€…ä¸å¸¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚ &lt;code&gt;await 42&lt;/code&gt;ï¼Œå¼•æ“ä»ç„¶éœ€è¦ä¸ºå…¶åˆ›å»º Promise åŒ…è£…å™¨ã€‚&lt;/p&gt;
&lt;p&gt;äº‹å®è¯æ˜ï¼Œè§„èŒƒä¸­å·²ç»æœ‰ä¸€ä¸ª &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promise-resolve&quot;&gt;&lt;code&gt;promiseResolve&lt;/code&gt;&lt;/a&gt; æ“ä½œï¼Œæ­¤æ“ä½œåªåœ¨éœ€è¦æ—¶æ‰§è¡ŒåŒ…è£…å™¨ï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-code-comparison.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æ­¤æ“ä½œè¿”å›æ²¡æœ‰ä¿®æ”¹è¿‡çš„ promiseï¼Œå¹¶ä¸”åªåœ¨å¿…è¦æ—¶å°†å…¶å€¼åŒ…è£…åˆ° promise ä¸­ã€‚å½“ä¼ é€’ç»™ &lt;code&gt;await&lt;/code&gt; çš„å€¼å·²ç»æ˜¯ä¸€ä¸ª Promise æ—¶ï¼Œè¿™å¯ä»¥èŠ‚çœå…¶ä¸­ä¸€ä¸ªé¢å¤–çš„ promiseï¼ŒåŠ ä¸Š microtick é˜Ÿåˆ—ä¸Šçš„ä¸¤ä¸ª tickã€‚ä» V8 v7.1 å¼€å§‹ï¼Œè¯¥è¡Œä¸ºå¯ä»¥é€šè¿‡ V8 çš„å‘½ä»¤è¡Œå‚æ•° &lt;code&gt;--harmony-await-optimization&lt;/code&gt; å¼€å¯ã€‚æˆ‘ä»¬ä¹Ÿæäº¤äº†å¯¹ &lt;a href=&quot;https://github.com/tc39/ecma262/pull/1250&quot;&gt;proposed this change to the ECMAScript specification&lt;/a&gt; çš„å˜æ›´ï¼›ä¸€æ—¦æˆ‘ä»¬ç¡®å®šå®ƒä¸ Web å…¼å®¹ï¼Œè¿™ä¸ªè¡¥ä¸å°±ä¼šåˆå¹¶åˆ°ææ¡ˆä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯åœ¨å¼•æ“åº•å±‚å¯¹ &lt;code&gt;await&lt;/code&gt; çš„æ”¹è¿›ï¼Œå…¶æŒ‰æ­¥æ‰§è¡Œçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-new-step-1.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;è®©æˆ‘ä»¬å†æ¬¡å‡è®¾æˆ‘ä»¬ &lt;code&gt;await&lt;/code&gt; åé¢çš„ Promise è¿”å›äº† &lt;code&gt;42&lt;/code&gt;ã€‚æ„Ÿè°¢ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promise-resolve&quot;&gt;&lt;code&gt;promiseResolve&lt;/code&gt;&lt;/a&gt; å¸¦æ¥çš„é­”æ³•ï¼Œç°åœ¨ &lt;code&gt;promise&lt;/code&gt; æŒ‡å‘äº†åŒä¸€ä¸ª Promise &lt;code&gt;v&lt;/code&gt;ï¼Œæ‰€ä»¥è¿™ä¸ªæ­¥éª¤ä»€ä¹ˆä¹Ÿä¸éœ€è¦åšã€‚ç„¶åå¼•æ“ç»§ç»­åƒä»¥å‰ä¸€æ ·ï¼Œåˆ›å»º &lt;code&gt;throwaway&lt;/code&gt; Promiseï¼Œå®‰æ’ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promisereactionjob&quot;&gt;&lt;code&gt;PromiseReactionJob&lt;/code&gt;&lt;/a&gt; åœ¨ microtask é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ª tick ä¸Šæ¢å¤å¼‚æ­¥å‡½æ•°ï¼Œæš‚åœæ‰§è¡Œè¯¥å‡½æ•°ï¼Œç„¶åè¿”å›ç»™è°ƒç”¨è€…ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-new-step-2.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æœ€ç»ˆå½“æ‰€æœ‰ JavaScript æ‰§è¡Œå®Œæˆæ—¶ï¼Œå¼•æ“å¼€å§‹è¿è¡Œ microtaskï¼Œå› æ­¤å®ƒæ‰§è¡Œ &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-promisereactionjob&quot;&gt;&lt;code&gt;PromiseReactionJob&lt;/code&gt;&lt;/a&gt;ã€‚è¿™ä¸ªè¿‡ç¨‹å°† &lt;code&gt;promise&lt;/code&gt; ä¼ æ’­åˆ° &lt;code&gt;throwaway&lt;/code&gt;ï¼Œå¹¶æ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œä¸º &lt;code&gt;await&lt;/code&gt; å¾—åˆ° &lt;code&gt;42&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-overhead-removed.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;èŠ‚çœäº†æ‰§è¡Œ &lt;code&gt;await&lt;/code&gt; çš„å¼€é”€&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;å¦‚æœä¼ é€’ç»™ &lt;code&gt;await&lt;/code&gt; çš„å€¼å·²ç»æ˜¯ä¸€ä¸ª Promiseï¼Œé‚£ä¹ˆè¿™ç§ä¼˜åŒ–é¿å…äº†å†æ¬¡åˆ›å»º Promise åŒ…è£…å™¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»&lt;strong&gt;æœ€å°‘ä¸‰ä¸ª&lt;/strong&gt; microtick åˆ°&lt;strong&gt;åªæœ‰ä¸€ä¸ª&lt;/strong&gt; microtickã€‚è¿™ç§è¡Œä¸ºç±»ä¼¼äº Node.js 8 æ‰€åšçš„ï¼Œä½†æ˜¯ç°åœ¨å®ƒä¸å†æ˜¯ä¸€ä¸ª bug - å®ƒç°åœ¨æ˜¯ä¸€ä¸ªæ­£åœ¨æ ‡å‡†åŒ–çš„ä¼˜åŒ–ï¼&lt;/p&gt;
&lt;p&gt;è™½ç„¶ &lt;code&gt;throwaway&lt;/code&gt; åªæ˜¯åœ¨ V8 å¼•æ“å†…éƒ¨ä½¿ç”¨ï¼Œä½†å¼•æ“å¿…é¡»åˆ›é€ è¿™ç§ Promiseã€‚äº‹å®è¯æ˜ï¼Œ&lt;code&gt;throwaway&lt;/code&gt; Promise åªæ˜¯ä¸ºäº†æ»¡è¶³ &lt;code&gt;performPromiseThen&lt;/code&gt; è§„èŒƒä¸­å†…éƒ¨æ“ä½œçš„ API çº¦æŸã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/await-optimized.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;æœ€è¿‘åœ¨ ECMAScript è§„èŒƒçš„&lt;a href=&quot;https://github.com/tc39/ecma262/issues/694&quot;&gt;ç¼–è¾‘æ€§æ›´æ”¹&lt;/a&gt;ä¸­è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¼•æ“ä¸å†éœ€è¦ä¸º &lt;code&gt;await&lt;/code&gt; åˆ›é€  &lt;code&gt;throwaway&lt;/code&gt; Promise - åœ¨ç»å¤§éƒ¨åˆ†æ—¶é—´&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/node-10-vs-node-12.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;&lt;code&gt;await&lt;/code&gt; ä¼˜åŒ–ä¹‹å‰å’Œä¹‹åçš„æ¯”è¾ƒ&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;åŒ Node.js 10 çš„ &lt;code&gt;await&lt;/code&gt; å¯¹æ¯”ï¼Œåœ¨ Node.js 12 ä¸­åšäº†æ›´è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œä¸‹å›¾æ˜¾ç¤ºäº†æ­¤æ›´æ”¹å¯¹æ€§èƒ½çš„å½±å“ï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/benchmark-optimization.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;async&lt;/code&gt;/&lt;code&gt;await&lt;/code&gt; ç°åœ¨ä¼˜äºæ‰‹å†™çš„ Promise ä»£ç &lt;/strong&gt;ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®è¡¥è§„èŒƒ&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt;ï¼Œå¤§å¤§å‡å°‘äº†å¼‚æ­¥å‡½æ•°çš„å¼€é”€ - ä¸ä»…åœ¨ V8 ä¸­ï¼Œè€Œä¸”åœ¨æ‰€æœ‰ JavaScript å¼•æ“ä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&quot;improved-developer-experience&quot;&gt;æ”¹å–„å¼€å‘è€…ä½“éªŒ &lt;a class=&quot;bookmark&quot; href=&quot;#improved-developer-experience&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;é™¤äº†æ€§èƒ½ä¹‹å¤–ï¼ŒJavaScript å¼€å‘è€…è¿˜å…³å¿ƒè¯Šæ–­å’Œä¿®å¤ bug çš„èƒ½åŠ›ï¼Œè¿™åœ¨å¤„ç†å¼‚æ­¥ä»£ç æ—¶é€šå¸¸ä¼šæ›´åŠ å›°éš¾ã€‚&lt;a href=&quot;https://developers.google.com/web/tools/chrome-devtools&quot;&gt;Chrome DevTools&lt;/a&gt; æ”¯æŒå¼‚æ­¥å †æ ˆè·Ÿè¸ªï¼Œå³å †æ ˆè·Ÿè¸ªä¸ä»…åŒ…æ‹¬å †æ ˆçš„å½“å‰åŒæ­¥éƒ¨åˆ†ï¼Œè¿˜åŒ…æ‹¬å¼‚æ­¥éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/fast-async/devtools.png&quot; srcset=&quot;https://v8.js.cn/_img/fast-async/devtools@2x.png 2x&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;è¿™æ˜¯æœ¬åœ°å¼€å‘è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦éƒ¨ç½²äº†åº”ç”¨ç¨‹åºï¼Œè¿™ç§æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£å¸®åŠ©æ‚¨ã€‚åœ¨çº¿ä¸Šè°ƒè¯•æœŸé—´ï¼Œæ‚¨åªä¼šåœ¨æ—¥å¿—æ–‡ä»¶ä¸­çœ‹åˆ° &lt;code&gt;Error#stack&lt;/code&gt; è¾“å‡ºï¼Œå¹¶ä¸”ä¸ä¼šå‘Šè¯‰æ‚¨æœ‰å…³å¼‚æ­¥éƒ¨åˆ†çš„ä»»ä½•ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æœ€è¿‘ä¸€ç›´åœ¨ç ”ç©¶&lt;a href=&quot;https://bit.ly/v8-zero-cost-async-stack-traces&quot;&gt;é›¶æˆæœ¬çš„å¼‚æ­¥å †æ ˆè·Ÿè¸ª&lt;/a&gt;ï¼Œå®ƒä¸ºå¼‚æ­¥å‡½æ•°è°ƒç”¨æä¾›äº†æ›´ä¸°å¯Œçš„ &lt;code&gt;Error#stack&lt;/code&gt; å±æ€§ã€‚â€œé›¶æˆæœ¬â€å¬èµ·æ¥ä»¤äººå…´å¥‹ï¼Œä¸æ˜¯å—ï¼Ÿå½“ Chrome DevTools ç‰¹æ€§å¸¦æ¥é‡å¤§å¼€é”€æ—¶ï¼Œå¦‚ä½•æ‰èƒ½å®ç°é›¶æˆæœ¬ï¼Ÿè€ƒè™‘è¿™ä¸ª &lt;code&gt;foo&lt;/code&gt; å¼‚æ­¥è°ƒç”¨ &lt;code&gt;bar&lt;/code&gt; çš„ä¾‹å­ï¼Œè€Œä¸” &lt;code&gt;bar&lt;/code&gt; åœ¨ &lt;code&gt;await&lt;/code&gt; çš„ Promise ä¹‹åæŠ›å‡ºå¼‚å¸¸ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; Promise&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;BEEP BEEP&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ Node.js 8 æˆ– Node.js 10 ä¸­è¿è¡Œæ­¤ä»£ç ä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;$ node index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;Error: BEEP BEEP&lt;/span&gt;&lt;br&gt;&lt;mark class=&quot;highlight-line highlight-line-active&quot;&gt;    at bar (index.js:8:9)&lt;/mark&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at process._tickCallback (internal/process/next_tick.js:68:7)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at startup (internal/bootstrap/node.js:266:19)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¯·æ³¨æ„ï¼Œè™½ç„¶è°ƒç”¨ &lt;code&gt;foo()&lt;/code&gt; å¯¼è‡´é”™è¯¯ï¼Œä½† &lt;code&gt;foo&lt;/code&gt; æ ¹æœ¬ä¸æ˜¯å †æ ˆè·Ÿè¸ªçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä½¿å¾— JavaScript å¼€å‘è€…æ‰§è¡Œäº‹åè°ƒè¯•å˜å¾—æ£˜æ‰‹ï¼Œæ— è®ºæ‚¨çš„ä»£ç æ˜¯éƒ¨ç½²åœ¨ Web åº”ç”¨ç¨‹åºä¸­è¿˜æ˜¯éƒ¨ç½²åœ¨äº‘å®¹å™¨å†…éƒ¨ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæœ‰è¶£çš„æ˜¯ï¼Œå¼•æ“çŸ¥é“ &lt;code&gt;bar&lt;/code&gt; è°ƒç”¨å®Œæˆæ—¶å®ƒç»§ç»­æ‰§è¡Œçš„ä½ç½®ï¼šåœ¨ &lt;code&gt;foo&lt;/code&gt; å‡½æ•°çš„ &lt;code&gt;await&lt;/code&gt; ä¹‹åã€‚å·§åˆçš„æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯å‡½æ•° &lt;code&gt;foo&lt;/code&gt; æš‚åœçš„åœ°æ–¹ã€‚å¼•æ“å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯æ¥é‡å»ºå¼‚æ­¥å †æ ˆè·Ÿè¸ªçš„éƒ¨åˆ†ï¼Œå³ &lt;code&gt;await&lt;/code&gt; ç°åœºã€‚é€šè¿‡æ­¤æ›´æ”¹ï¼Œè¾“å‡ºå˜ä¸ºï¼š&lt;/p&gt;
&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;$ node --async-stack-traces index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;Error: BEEP BEEP&lt;/span&gt;&lt;br&gt;&lt;mark class=&quot;highlight-line highlight-line-active&quot;&gt;    at bar (index.js:8:9)&lt;/mark&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at process._tickCallback (internal/process/next_tick.js:68:7)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at startup (internal/bootstrap/node.js:266:19)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)&lt;/span&gt;&lt;br&gt;&lt;mark class=&quot;highlight-line highlight-line-active&quot;&gt;    at async foo (index.js:2:3)&lt;/mark&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨å †æ ˆè·Ÿè¸ªä¸­ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°é¦–å…ˆå‡ºç°ï¼Œç„¶åæ˜¯åŒæ­¥å †æ ˆè·Ÿè¸ªçš„å…¶ä½™éƒ¨åˆ†ï¼Œç„¶åæ˜¯ &lt;code&gt;bar&lt;/code&gt; å‡½æ•°çš„å¼‚æ­¥è°ƒç”¨ &lt;code&gt;foo&lt;/code&gt;ã€‚æ­¤æ›´æ”¹åœ¨ V8 ä¸­ä½¿ç”¨ &lt;code&gt;--async-stack-traces&lt;/code&gt; æ ‡å¿—å¼€å¯ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œå¦‚æœå°†æ­¤ä¸ä¸Šé¢ Chrome DevTools ä¸­çš„å¼‚æ­¥å †æ ˆè·Ÿè¸ªè¿›è¡Œæ¯”è¾ƒï¼Œæ‚¨ä¼šæ³¨æ„åˆ° &lt;code&gt;foo&lt;/code&gt; å †æ ˆè·Ÿè¸ªçš„å¼‚æ­¥éƒ¨åˆ†ä¸­ç¼ºå°‘å®é™…çš„è°ƒç”¨ç°åœºã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™ç§æ–¹æ³•åˆ©ç”¨äº†ä¸€ä¸ªäº‹å®ï¼Œ&lt;code&gt;await&lt;/code&gt; å³æ¢å¤å’Œæš‚åœä½ç½®æ˜¯ç›¸åŒçš„ - ä½†å¯¹äºå¸¸è§„ &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then&quot;&gt;&lt;code&gt;Promise#then()&lt;/code&gt;&lt;/a&gt; æˆ– &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch&quot;&gt;&lt;code&gt;Promise#catch()&lt;/code&gt;&lt;/a&gt; è°ƒç”¨ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ã€‚æœ‰å…³æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚é˜… Mathias Bynens å¯¹&lt;a href=&quot;https://mathiasbynens.be/notes/async-stack-traces&quot;&gt;why &lt;code&gt;await&lt;/code&gt; beats &lt;code&gt;Promise#then()&lt;/code&gt;&lt;/a&gt; çš„è§£é‡Šã€‚&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;ç»“è®º &lt;a class=&quot;bookmark&quot; href=&quot;#conclusion&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ç”±äºä¸¤ä¸ªé‡è¦çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä½¿å¼‚æ­¥å‡½æ•°æ›´å¿«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åˆ é™¤ä¸¤ä¸ªé¢å¤–çš„ microtickï¼Œå’Œ&lt;/li&gt;
&lt;li&gt;å»é™¤äº† &lt;code&gt;throwaway&lt;/code&gt; promiseã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡&lt;a href=&quot;https://bit.ly/v8-zero-cost-async-stack-traces&quot;&gt;é›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ª&lt;/a&gt;æ”¹è¿›äº†å¼€å‘ä½“éªŒï¼Œè¿™äº›å¯ä»¥ä½¿ç”¨åœ¨å¼‚æ­¥å‡½æ•°çš„ &lt;code&gt;await&lt;/code&gt; è¡¨è¾¾å¼å’Œå¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ &lt;code&gt;Promise.all()&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿˜ä¸º JavaScript å¼€å‘è€…æä¾›äº†ä¸€äº›å¾ˆå¥½çš„æ€§èƒ½å»ºè®®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ &lt;code&gt;async&lt;/code&gt; å‡½æ•°å’Œ &lt;code&gt;await&lt;/code&gt; æ›¿ä»£æ‰‹å†™çš„ Promise ä»£ç ï¼Œä»¥åŠ&lt;/li&gt;
&lt;li&gt;åšæŒ JavaScript å¼•æ“æä¾›çš„åŸç”Ÿ Promise å®ç°ï¼Œä»¥é¿å…åœ¨ &lt;code&gt;await&lt;/code&gt; ä¸­ä½¿ç”¨é¢å¤–çš„ä¸¤ä¸ª microtickã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;æ„Ÿè°¢ &lt;a href=&quot;https://twitter.com/matteocollina&quot;&gt;Matteo Collina&lt;/a&gt; ä¸ºæ­¤æäº¤çš„ &lt;a href=&quot;https://github.com/mcollina/make-promises-safe/blob/master/README.md#the-unhandledrejection-problem&quot;&gt;issue&lt;/a&gt;. &lt;a href=&quot;#fnref1&quot; class=&quot;footnote-backref&quot;&gt;â†©ï¸&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;å¦‚æœåœ¨ Node.js ä¸­ä½¿ç”¨ &lt;a href=&quot;https://nodejs.org/api/async_hooks.html&quot;&gt;&lt;code&gt;async_hooks&lt;/code&gt;&lt;/a&gt;ï¼ŒV8 ä»ç„¶éœ€è¦åˆ›å»º &lt;code&gt;throwaway&lt;/code&gt;ï¼Œå› ä¸º &lt;code&gt;before&lt;/code&gt; å’Œ &lt;code&gt;after&lt;/code&gt; é’©å­éœ€è¦åœ¨ &lt;code&gt;throwaway&lt;/code&gt; çš„ promise &lt;em&gt;ä¸Šä¸‹æ–‡ä¸­&lt;/em&gt;è¿è¡Œã€‚ &lt;a href=&quot;#fnref2&quot; class=&quot;footnote-backref&quot;&gt;â†©ï¸&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;å¦‚ä¸Šæ‰€è¿°ï¼Œ&lt;a href=&quot;https://github.com/tc39/ecma262/pull/1250&quot;&gt;æ­¤è¡¥ä¸&lt;/a&gt;å°šæœªåˆå¹¶åˆ° ECMAScript è§„èŒƒä¸­ã€‚ä¸€æ—¦æˆ‘ä»¬ç¡®ä¿æ­¤æ”¹å˜ä¸ä¼šç ´åç½‘ç»œï¼Œæˆ‘ä»¬çš„è®¡åˆ’å°±æ˜¯é©¬ä¸Šæ‰§è¡Œã€‚ &lt;a href=&quot;#fnref3&quot; class=&quot;footnote-backref&quot;&gt;â†©ï¸&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  
  <entry>
    <title>V8 v7.1 å‘å¸ƒ</title>
    <link href="https://v8.js.cn/blog/v8-release-71"/>
    <updated>2018-10-31T15:44:37+00:00</updated>
    <id>https://v8.js.cn/blog/v8-release-71</id>
    <author>
      <name>Stephan Herhut (@herhut), cloned cloner of clones</name>
    </author>
    <content type="html">&lt;p&gt;æ¯å…­å‘¨ï¼Œæˆ‘ä»¬ä¼šæŒ‰ç…§ &lt;a href=&quot;https://v8.js.cn/docs/release-process&quot;&gt;V8 çš„å‘å¸ƒæµç¨‹&lt;/a&gt;åˆ›å»ºä¸€ä¸ªæ–°çš„ V8 åˆ†æ”¯ã€‚åœ¨è¿›å…¥ Chrome Beta é‡Œç¨‹ç¢‘ä¹‹å‰ï¼Œæ­¤ç‰ˆæœ¬ä» V8 çš„ master åˆ†æ”¯åˆ›å»ºå‡ºæ¥ã€‚ä»Šå¤©æˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒå½“å‰æœ€æ–°çš„åˆ†æ”¯å¼‚å¸¸åˆ›å»ºå‡ºæ¥äº†ï¼Œ&lt;a href=&quot;https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/7.1&quot;&gt;V8 version 7.1&lt;/a&gt;ï¼Œå®ƒå°†åœ¨å‡ ä¸ªæ˜ŸæœŸå†…ä¸ Chrome 71 Stable åŒæ—¶å‘å¸ƒã€‚V8 v7.1 åŒ…å«äº†å„ç§é¢å‘å¼€å‘è€…çš„æ–°ç‰¹æ€§ã€‚è¿™ç¯‡æ–‡ç« æä¾›äº†é¢„æœŸå‘å¸ƒçš„ä¸€äº›åŠŸèƒ½äº®ç‚¹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;memory&quot;&gt;å†…å­˜ &lt;a class=&quot;bookmark&quot; href=&quot;#memory&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;åœ¨ v6.9/v7.0 ä¸­&lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;å°†å†…ç½®å‡½æ•°ç›´æ¥ä»¥äºŒè¿›åˆ¶æ–¹å¼åµŒå…¥&lt;/a&gt;åï¼Œè§£é‡Šå™¨çš„å­—èŠ‚ç å¤„ç†ç¨‹åºç°åœ¨ä¹Ÿ&lt;a href=&quot;https://bugs.chromium.org/p/v8/issues/detail?id=8068&quot;&gt;åµŒå…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­&lt;/a&gt;ã€‚æ¯ä¸ª Isolate å¹³å‡èŠ‚çœå¤§çº¦ 200 KBã€‚&lt;/p&gt;
&lt;h2 id=&quot;performance&quot;&gt;æ€§èƒ½ &lt;a class=&quot;bookmark&quot; href=&quot;#performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;TurboFan ä¸­çš„é€ƒé€¸åˆ†æï¼ˆå¯¹å±€éƒ¨ä½œç”¨åŸŸçš„å¯¹è±¡æ‰§è¡Œæ ‡é‡æ›¿æ¢ï¼‰å¾—åˆ°äº†æ”¹è¿›ï¼Œå½“æ¥è‡ªå‘¨å›´ä¸Šä¸‹æ–‡çš„å˜é‡è½¬ç§»åˆ°æœ¬åœ°é—­åŒ…æ—¶ï¼Œå®ƒè¿˜èƒ½å¤Ÿ&lt;a href=&quot;https://bit.ly/v8-turbofan-context-sensitive-js-operators&quot;&gt;å¤„ç†é«˜é˜¶å‡½æ•°çš„å±€éƒ¨å‡½æ•°ä¸Šä¸‹æ–‡&lt;/a&gt;ã€‚è¯·è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mapAdd&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ³¨æ„ï¼Œè¿™é‡Œçš„ &lt;code&gt;x&lt;/code&gt; æ˜¯å±€éƒ¨ä½œç”¨åŸŸé—­åŒ… &lt;code&gt;y =&amp;gt; y + x&lt;/code&gt; çš„è‡ªç”±å˜é‡ã€‚V8 v7.1 ç°åœ¨å¯ä»¥å®Œå…¨å¿½ç•¥ä¸Šä¸‹æ–‡ä¸­åˆ†é…çš„ &lt;code&gt;x&lt;/code&gt;ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥æé«˜ 40%ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-release-71/improved-escape-analysis.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;é€šè¿‡æ–°çš„é€ƒé€¸åˆ†ææå‡æ€§èƒ½ï¼ˆè¶Šä½è¶Šå¥½ï¼‰&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;é€ƒé€¸åˆ†æç°åœ¨è¿˜èƒ½å¤Ÿæ¶ˆé™¤ä½¿ç”¨å˜é‡ä½œä¸ºç´¢å¼•è®¿é—®å±€éƒ¨æ•°æ®çš„è¡Œä¸ºã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; total &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    total &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; total&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¯·æ³¨æ„ï¼Œ&lt;code&gt;args&lt;/code&gt; æ˜¯ &lt;code&gt;sum2&lt;/code&gt; çš„å±€éƒ¨å˜é‡ï¼ˆå‡è®¾ &lt;code&gt;sum&lt;/code&gt; è¢«å†…è”è¿›äº† &lt;code&gt;sum2&lt;/code&gt;ï¼‰ã€‚åœ¨ V8 v7.1 ä¸­ï¼ŒTurboFan ç°åœ¨å¯ä»¥æŠŠ &lt;code&gt;args&lt;/code&gt; å®Œå…¨æ¶ˆé™¤ï¼Œå¹¶ä½¿ç”¨ä¸‰å…ƒæ“ä½œ &lt;code&gt;i === 0 ? x : y&lt;/code&gt; æ›¿æ¢å˜é‡ç´¢å¼•è®¿é—®æ“ä½œ &lt;code&gt;args[i]&lt;/code&gt;ã€‚åœ¨ä½¿ç”¨ JetStream/EarleyBoyer è¿›è¡ŒåŸºå‡†æµ‹è¯•æ—¶ï¼Œæ€§èƒ½æé«˜äº†çº¦ 2%ã€‚æˆ‘ä»¬å°†æ¥ä¼šç»§ç»­æ‰©å±•æ­¤ä¼˜åŒ–ï¼Œä½¿å…·æœ‰ä¸¤ä¸ªä»¥ä¸Šå…ƒç´ çš„æ•°ç»„ä¹Ÿå¯ä»¥è¿›è¡Œç±»ä¼¼ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;h2 id=&quot;structured-cloning-of-wasm-modules&quot;&gt;Wasm modules çš„ç»“æ„åŒ–å…‹éš† &lt;a class=&quot;bookmark&quot; href=&quot;#structured-cloning-of-wasm-modules&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;æœ€åï¼Œ&lt;a href=&quot;https://github.com/WebAssembly/design/pull/1074&quot;&gt;&lt;code&gt;postMessage&lt;/code&gt; is supported for Wasm modules&lt;/a&gt;ã€‚&lt;code&gt;WebAssembly.Module&lt;/code&gt; å¯¹è±¡ç°åœ¨å¯ä»¥è¢« &lt;code&gt;postMessage&lt;/code&gt; å‘é€åˆ° web workersã€‚ä¸ºäº†æ›´åŠ æ¸…æ™°ï¼Œè¿™ä»…é™äº web workersï¼ˆç›¸åŒçš„è¿›ç¨‹ï¼Œä¸åŒçš„çº¿ç¨‹ï¼‰ï¼Œè€Œä¸èƒ½æ‰©å±•åˆ°è·¨è¿›ç¨‹åœºæ™¯ï¼ˆä¾‹å¦‚è·¨åŸŸ(cross-origin) &lt;code&gt;postMessage&lt;/code&gt; æˆ– shared web workersï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&quot;javascript-language-features&quot;&gt;JavaScript è¯­è¨€æ–°ç‰¹æ€§ &lt;a class=&quot;bookmark&quot; href=&quot;#javascript-language-features&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/47417391&quot;&gt;&lt;code&gt;Intl.RelativeTimeFormat&lt;/code&gt; API&lt;/a&gt; å¯ä»¥è®©æˆ‘ä»¬å¤„ç†ç›¸å¯¹æ—¶é—´çš„æœ¬åœ°åŒ–æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œâ€œæ˜¨å¤©â€ï¼Œâ€œ42ç§’å‰â€æˆ–â€œ3ä¸ªæœˆâ€ï¼‰ï¼Œè€Œä¸ç‰ºç‰²æ€§èƒ½ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// åˆ›å»ºä¸€ä¸ªæœ¬åœ°åŒ–ç›¸å¯¹æ—¶é—´ï¼Œä¸­æ–‡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; rtf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Intl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RelativeTimeFormat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;zh&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; numeric&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;auto&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;day&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;æ˜¨å¤©&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;day&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;ä»Šå¤©&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;day&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;æ˜å¤©&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;week&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;ä¸Šå‘¨&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;week&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;æœ¬å‘¨&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;rtf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;week&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ &#39;ä¸‹å‘¨&#39;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æœ‰å…³ &lt;code&gt;Intl.RelativeTimeFormat&lt;/code&gt; çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» Google Web Fundamentals çš„ &lt;a href=&quot;https://developers.google.com/web/updates/2018/10/intl-relativetimeformat&quot;&gt;The Intl.RelativeTimeFormat API&lt;/a&gt; æ–‡ç« ï¼Œä¸­æ–‡ç¿»è¯‘ç‰ˆ&lt;a href=&quot;https://zhuanlan.zhihu.com/p/47417391&quot;&gt;å›½é™…åŒ–ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–APIï¼šIntl.RelativeTimeFormat&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;V8 v7.1 è¿˜å¢åŠ äº†å¯¹ &lt;a href=&quot;https://github.com/tc39/proposal-global&quot;&gt;&lt;code&gt;globalThis&lt;/code&gt; ææ¡ˆ&lt;/a&gt;çš„æ”¯æŒï¼Œæ­¤ææ¡ˆæä¾›äº†è®¿é—®å…¨å±€å¯¹è±¡çš„é€šç”¨æœºåˆ¶ï¼Œå³ä½¿åœ¨ä¸¥æ ¼æ¨¡å¼çš„å‡½æ•°æˆ–æ¨¡å—ä¸­ï¼Œè€Œä¸ç®¡å¹³å°å¦‚ä½•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;v8-api&quot;&gt;V8 API &lt;a class=&quot;bookmark&quot; href=&quot;#v8-api&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;è¯·ä½¿ç”¨ &lt;code&gt;git log branch-heads/7.0..branch-heads/7.1 include/v8.h&lt;/code&gt; è·å– API çš„å˜æ›´åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;p&gt;å¼€å‘è€…å¯ä»¥ä½¿ç”¨ &lt;code&gt;git checkout -b 7.1 -t branch-heads/7.1&lt;/code&gt; æ¥ä½¿ç”¨ V8 v7.1 ä¸­çš„å®éªŒæ€§æ–°åŠŸèƒ½ï¼Œå…·ä½“è¯·å‚é˜…&lt;a href=&quot;https://v8.js.cn/docs/source-code#using-git&quot;&gt;ä½¿ç”¨ Git è·å– V8 æºç &lt;/a&gt;ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥è®¢é˜… &lt;a href=&quot;https://www.google.com/chrome/browser/beta.html&quot;&gt;Chrome çš„ Beta é¢‘é“&lt;/a&gt; æ¥å°½å¿«å°è¯•æ–°åŠŸèƒ½ã€‚&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>V8 release v7.0</title>
    <link href="https://v8.js.cn/blog/v8-release-70"/>
    <updated>2018-10-15T17:17:00+00:00</updated>
    <id>https://v8.js.cn/blog/v8-release-70</id>
    <author>
      <name>Michael Hablich</name>
    </author>
    <content type="html">&lt;p&gt;Every six weeks, we create a new branch of V8 as part of our &lt;a href=&quot;https://github.com/v8/v8/wiki/Release-Process&quot;&gt;release process&lt;/a&gt;. Each version is branched from V8â€™s Git master immediately before a Chrome Beta milestone. Today weâ€™re pleased to announce our newest branch, &lt;a href=&quot;https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/7.0&quot;&gt;V8 version 7.0&lt;/a&gt;, which is in beta until its release in coordination with Chrome 70 Stable in several weeks. V8 v7.0 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.&lt;/p&gt;
&lt;h2 id=&quot;embedded-built-ins&quot;&gt;Embedded built-ins &lt;a class=&quot;bookmark&quot; href=&quot;#embedded-built-ins&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;Embedded builtins&lt;/a&gt; save memory by sharing generated code across multiple V8 Isolates. Starting with V8 v6.9, we enabled embedded builtins on x64. V8 v7.0 brings these memory savings to all remaining platforms except ia32.&lt;/p&gt;
&lt;h2 id=&quot;a-preview-of-webassembly-threads&quot;&gt;A preview of WebAssembly Threads &lt;a class=&quot;bookmark&quot; href=&quot;#a-preview-of-webassembly-threads&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;WebAssembly (Wasm) enables compilation of code written in C++ and other languages to run on the web. One very useful feature of native applications is the ability to use threads â€” a primitive for parallel computation. Most C and C++ developers would be familiar with pthreads, which is a standardized API for application thread management.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://www.w3.org/community/webassembly/&quot;&gt;WebAssembly Community Group&lt;/a&gt; has been working on bringing threads to the web to enable real multi-threaded applications. As part of this effort, V8 has implemented necessary support for threads in the WebAssembly engine. To use this feature in Chrome, you can enable it via &lt;code&gt;chrome://flags/#enable-webassembly-threads&lt;/code&gt;, or your site can sign up for an &lt;a href=&quot;https://github.com/GoogleChrome/OriginTrials&quot;&gt;Origin Trial&lt;/a&gt;. Origin Trials allow developers to experiment with new web features before they are fully standardized, and that helps us gather real-world feedback which is critical to validate and improve new features.&lt;/p&gt;
&lt;h2 id=&quot;javascript-language-features&quot;&gt;JavaScript language features &lt;a class=&quot;bookmark&quot; href=&quot;#javascript-language-features&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://tc39.github.io/proposal-Symbol-description/&quot;&gt;A &lt;code&gt;description&lt;/code&gt; property&lt;/a&gt; is being added to &lt;code&gt;Symbol.prototype&lt;/code&gt;. This provides a more ergonomic way of accessing the description of a &lt;code&gt;Symbol&lt;/code&gt;. Previously, the description could be only be accessed indirectly through &lt;code&gt;Symbol.prototype.toString()&lt;/code&gt;. Thanks to Igalia for contributing this implementation!&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Array.prototype.sort&lt;/code&gt; is now stable in V8 v7.0. Previously, V8 used an unstable QuickSort for arrays with more than 10 elements. Now, we use the stable TimSort algorithm. See &lt;a href=&quot;https://v8.js.cn/blog/array-sort&quot;&gt;our blog post&lt;/a&gt; for more details.&lt;/p&gt;
&lt;h2 id=&quot;v8-api&quot;&gt;V8 API &lt;a class=&quot;bookmark&quot; href=&quot;#v8-api&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Please use &lt;code&gt;git log branch-heads/6.9..branch-heads/7.0 include/v8.h&lt;/code&gt; to get a list of the API changes.&lt;/p&gt;
&lt;p&gt;Developers with an &lt;a href=&quot;https://github.com/v8/v8/wiki/Using-Git&quot;&gt;active V8 checkout&lt;/a&gt; can use &lt;code&gt;git checkout -b 7.0 -t branch-heads/7.0&lt;/code&gt; to experiment with the new features in V8 v7.0. Alternatively you can &lt;a href=&quot;https://www.google.com/chrome/browser/beta.html&quot;&gt;subscribe to Chromeâ€™s Beta channel&lt;/a&gt; and try the new features out yourself soon.&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>Getting things sorted in V8</title>
    <link href="https://v8.js.cn/blog/array-sort"/>
    <updated>2018-09-28T11:20:37+00:00</updated>
    <id>https://v8.js.cn/blog/array-sort</id>
    <author>
      <name>Simon ZÃ¼nd (@nimODota), consistent comparator</name>
    </author>
    <content type="html">&lt;p&gt;&lt;code&gt;Array.prototype.sort&lt;/code&gt; was among the last builtins implemented in self-hosted JavaScript in V8. Porting it offered us the opportunity to experiment with different algorithms and implementation strategies and finally &lt;a href=&quot;https://mathiasbynens.be/demo/sort-stability&quot;&gt;make it stable&lt;/a&gt; in V8 v7.0 / Chrome 70.&lt;/p&gt;
&lt;h2 id=&quot;background&quot;&gt;Background &lt;a class=&quot;bookmark&quot; href=&quot;#background&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Sorting in JavaScript is hard. This blog post looks at some of the quirks in the interaction between a sorting algorithm and the JavaScript language, and describes our journey to move V8 to a stable algorithm and make performance more predictable.&lt;/p&gt;
&lt;p&gt;When comparing different sorting algorithms we look at their worst and average performance given as a bound on the asymptotic growth (i.e. â€œBig Oâ€ notation) of either memory operations or number of comparisons. Note that in dynamic languages, such as JavaScript, a comparison operation is usually a magnitude more expensive than a memory access. This is due to the fact that comparing two values while sorting usually involves calls to user code.&lt;/p&gt;
&lt;p&gt;Letâ€™s take a look at a simple example of sorting some numbers into ascending order based on a user-provided comparison function. A &lt;em&gt;consistent&lt;/em&gt; comparison function returns &lt;code&gt;-1&lt;/code&gt; (or any other negative value), &lt;code&gt;0&lt;/code&gt;, or &lt;code&gt;1&lt;/code&gt; (or any other positive value) when the two provided values are either smaller, equal, or greater respectively. A comparison function that does not follow this pattern is &lt;em&gt;inconsistent&lt;/em&gt; and can have arbitrary side-effects, such as modifying the array itâ€™s intended to sort.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compare&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token comment&quot;&gt;// Arbitrary code goes here, e.g. `array.push(1);`.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// A â€œtypicalâ€ sort call.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;compare&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Even in the next example, calls to user code may happen. The â€œdefaultâ€ comparison function calls &lt;code&gt;toString&lt;/code&gt; on both values and does a lexicographical comparison on the string representations.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token comment&quot;&gt;// Arbitrary code goes here, e.g. `array.push(1);`.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;42&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Sort without a comparison function.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;accessors-prototype&quot;&gt;More fun with accessors and prototype-chain interactions &lt;a class=&quot;bookmark&quot; href=&quot;#accessors-prototype&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;This is the part where we leave the spec behind and venture into â€œimplementation-definedâ€ behavior land. The spec has a whole list of conditions that, when met, allow the engine to sort the object/array as it sees fit â€” or not at all. Engines still have to follow some ground rules but everything else is pretty much up in the air. On the one hand, this gives engine developers the freedom to experiment with different implementations. On the other hand, users expect some reasonable behavior even though the spec doesnâ€™t require there to be any. This is further complicated by the fact that â€œreasonable behaviorâ€ is not always straightforward to determine.&lt;/p&gt;
&lt;p&gt;This section shows that there are still some aspects of &lt;code&gt;Array#sort&lt;/code&gt; where engine behavior differs greatly. These are hard edge cases, and as mentioned above itâ€™s not always clear what â€œthe right thing to doâ€ actually is. We &lt;em&gt;highly&lt;/em&gt; recommend not writing code like this; engines wonâ€™t optimize for it.&lt;/p&gt;
&lt;p&gt;The first example shows an array with some accessors (i.e. getters and setters) and a â€œcall logâ€ in different JavaScript engines. Accessors are the first case where the resulting sort order is implementation-defined:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;array&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;0&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;get 0&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;set 0&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;array&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;get 1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;set 1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hereâ€™s the output of that snippet in various engines. Note that there are no â€œrightâ€ or â€œwrongâ€ answers here â€” the spec leaves this up to the implementation!&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Chakra
get 0
get 1
set 0
set 1

// JavaScriptCore
get 0
get 1
get 0
get 0
get 1
get 1
set 0
set 1

// V8
get 0
get 0
get 1
get 1
get 1
get 0

#### SpiderMonkey
get 0
get 1
set 0
set 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The next example shows interactions with the prototype chain. For the sake of brevity we donâ€™t show the call log.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; object &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; __proto__&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   length&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;8000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token number&quot;&gt;12000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;XX&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   __proto__&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;f3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;     &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sort&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The output shows the &lt;code&gt;object&lt;/code&gt; after itâ€™s sorted. Again, there is no right answer here. This example just shows how weird the interaction between indexed properties and the prototype chain can get:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Chakra&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// JavaScriptCore&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// V8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// SpiderMonkey&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;b2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;c2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;d2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;e3&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; undefined&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;before-sort&quot;&gt;What V8 does before actually sorting &lt;a class=&quot;bookmark&quot; href=&quot;#before-sort&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;V8 has two pre-processing steps before it actually sorts anything. First, if the object to sort has holes and elements on the prototype chain, they are copied from the prototype chain to the object itself. This frees us from caring about the prototype chain during all remaining steps. This is currently only done for non-&lt;code&gt;JSArray&lt;/code&gt;s but other engines do it for &lt;code&gt;JSArray&lt;/code&gt;s as well.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/copy-prototype.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Copying from the prototype chain&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;The second pre-processing step is the removal of holes. All elements in the sort-range are moved to the beginning of the object. &lt;code&gt;undefined&lt;/code&gt;s are moved after that. This is even required by the spec to some degree as it requires us to &lt;em&gt;always&lt;/em&gt; sort &lt;code&gt;undefined&lt;/code&gt;s to the end. The result is that a user-provided comparison function will never get called with an &lt;code&gt;undefined&lt;/code&gt; argument. After the second pre-processing step the sorting algorithm only needs to consider non-&lt;code&gt;undefined&lt;/code&gt;s, potentially reducing the number of elements it actually has to sort.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/remove-array-holes.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Removing holes and moving &lt;code&gt;undefined&lt;/code&gt;s to the end&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;history&quot;&gt;History &lt;a class=&quot;bookmark&quot; href=&quot;#history&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Array.prototype.sort&lt;/code&gt; and &lt;code&gt;TypedArray.prototype.sort&lt;/code&gt; relied on the same Quicksort implementation written in JavaScript. The sorting algorithm itself is rather straightforward: The basis is a Quicksort with an Insertion Sort fall-back for shorter arrays (length &amp;lt; 10). The Insertion Sort fall-back was also used when Quicksort recursion reached a sub-array length of 10. Insertion Sort is more efficient for smaller arrays. This is because Quicksort gets called recursively twice after partitioning. Each such recursive call had the overhead of creating (and discarding) a stack frame.&lt;/p&gt;
&lt;p&gt;Choosing a suitable pivot element has a big impact when it comes to Quicksort. V8 employed two strategies:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The pivot was chosen as the median of the first, last, and a third element of the sub-array that gets sorted. For smaller arrays that third element is simply the middle element.&lt;/li&gt;
&lt;li&gt;For larger arrays a sample was taken, then sorted and the median of the sorted sample served as the third element in the above calculation.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One of the advantages of Quicksort is that it sorts in-place. The memory overhead comes from allocating a small array for the sample when sorting large arrays, and log(n) stack space. The downside is that itâ€™s not a stable algorithm and thereâ€™s a chance the algorithm hits the worst-case scenario where QuickSort degrades to O(n^2).&lt;/p&gt;
&lt;h3 id=&quot;introducing-v8-torque&quot;&gt;Introducing V8 Torque &lt;a class=&quot;bookmark&quot; href=&quot;#introducing-v8-torque&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As an avid reader of the V8 blog you might have heard of &lt;a href=&quot;https://v8.js.cn/blog/csa&quot;&gt;&lt;code&gt;CodeStubAssembler&lt;/code&gt;&lt;/a&gt; or CSA for short. CSA is a V8 component that allows us to write low-level TurboFan IR directly in C++ that later gets translated to machine code for the appropriate architecture using TurboFanâ€™s backend.&lt;/p&gt;
&lt;p&gt;CSA is heavily utilized to write so-called â€œfast-pathsâ€ for JavaScript builtins. A fast-path version of a builtin usually checks whether certain invariants hold (e.g. no elements on the prototype chain, no accessors, etc) and then uses faster, more specific operations to implement the builtin functionality. This can result in execution times that are an order of magnitude faster than a more generic version.&lt;/p&gt;
&lt;p&gt;The downside of CSA is that it really can be considered an assembly language. Control-flow is modeled using explicit &lt;code&gt;labels&lt;/code&gt; and &lt;code&gt;gotos&lt;/code&gt;, which makes implementing more complex algorithms in CSA hard to read and error-prone.&lt;/p&gt;
&lt;p&gt;Enter &lt;a href=&quot;https://v8.js.cn/docs/torque&quot;&gt;V8 Torque&lt;/a&gt;. Torque is a domain-specific language with TypeScript-like syntax that currently uses CSA as its sole compilation target. Torque allows nearly the same level of control as CSA does while at the same time offering higher-level constructs such as &lt;code&gt;while&lt;/code&gt; and &lt;code&gt;for&lt;/code&gt; loops. Additionally, itâ€™s strongly typed and will in the future contain security checks such as automatic out-of-bound checks providing V8 engineers with stronger guarantees.&lt;/p&gt;
&lt;p&gt;The first major builtins that were re-written in V8 Torque were &lt;a href=&quot;https://v8.js.cn/blog/v8-release-68&quot;&gt;&lt;code&gt;TypedArray#sort&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://v8.js.cn/blog/dataview&quot;&gt;&lt;code&gt;Dataview&lt;/code&gt; operations&lt;/a&gt;. Both served the additional purpose of providing feedback to the Torque developers on what languages features are needed and idioms should be used to write builtins efficiently. At the time of writing, several &lt;code&gt;JSArray&lt;/code&gt; builtins had their self-hosted JavaScript fall-back implementations moved to Torque (e.g. &lt;code&gt;Array#unshift&lt;/code&gt;) while others were completely re-written (e.g. &lt;code&gt;Array#splice&lt;/code&gt; and &lt;code&gt;Array#reverse&lt;/code&gt;).&lt;/p&gt;
&lt;h3 id=&quot;moving-array%23sort-to-torque&quot;&gt;Moving &lt;code&gt;Array#sort&lt;/code&gt; to Torque &lt;a class=&quot;bookmark&quot; href=&quot;#moving-array%23sort-to-torque&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The initial &lt;code&gt;Array#sort&lt;/code&gt; Torque version was more or less a straight up port of the JavaScript implementation. The only difference was that instead of using a sampling approach for larger arrays, the third element for the pivot calculation was chosen at random.&lt;/p&gt;
&lt;p&gt;This worked reasonably well, but as it still utilized Quicksort, &lt;code&gt;Array#sort&lt;/code&gt; remained unstable. &lt;a href=&quot;https://bugs.chromium.org/p/v8/issues/detail?id=90&quot;&gt;The request for a stable &lt;code&gt;Array#sort&lt;/code&gt;&lt;/a&gt; is among the oldest tickets in V8â€™s bug tracker. Experimenting with Timsort as a next step offered us multiple things. First, we like that itâ€™s stable and offers some nice algorithmic guarantees (see next section). Second, Torque was still a work-in-progress and implementing a more complex builtin such as &lt;code&gt;Array#sort&lt;/code&gt; with Timsort resulted in lots of actionable feedback influencing Torque as a language.&lt;/p&gt;
&lt;h2 id=&quot;timsort&quot;&gt;Timsort &lt;a class=&quot;bookmark&quot; href=&quot;#timsort&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Timsort, initially developed by Tim Peters for Python in 2002, could best be described as an adaptive stable Mergesort variant. Even though the details are rather complex and are best described by &lt;a href=&quot;https://github.com/python/cpython/blob/master/Objects/listsort.txt&quot;&gt;the man himself&lt;/a&gt; or the &lt;a href=&quot;https://en.wikipedia.org/wiki/Timsort&quot;&gt;Wikipedia page&lt;/a&gt;, the basics are easy to understand. While Mergesort usually works in recursive fashion, Timsort works iteratively. It processes an array from left to right and looks for so-called &lt;em&gt;runs&lt;/em&gt;. A run is simply a sequence that is already sorted. This includes sequences that are sorted â€œthe wrong wayâ€ as these sequences can simply be reversed to form a run. At the start of the sorting process a minimum run length is determined that depends on the length of the input. If Timsort canâ€™t find natural runs of this minimum run length a run is â€œboosted artificiallyâ€ using Insertion Sort.&lt;/p&gt;
&lt;p&gt;Runs that are found this way are tracked using a stack that remembers a starting index and a length of each run. From time to time runs on the stack are merged together until only one sorted run remains. Timsort tries to maintain a balance when it comes to deciding which runs to merge. On the one hand you want to try and merge early as the data of those runs has a high chance of already being in the cache, on the other hand you want to merge as late as possible to take advantage of patterns in the data that might emerge. To accomplish this, Timsort maintains two invariants. Assuming &lt;code&gt;A&lt;/code&gt;, &lt;code&gt;B&lt;/code&gt;, and &lt;code&gt;C&lt;/code&gt; are the three top-most runs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;|C| &amp;gt; |B| + |A|&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;|B| &amp;gt; |A|&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/runs-stack.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Runs stack before and after merging &lt;code&gt;A&lt;/code&gt; with &lt;code&gt;B&lt;/code&gt;&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;The image shows the case where &lt;code&gt;|A| &amp;gt; |B|&lt;/code&gt; so &lt;code&gt;B&lt;/code&gt; is merged with the smaller of the two runs.&lt;/p&gt;
&lt;p&gt;Note that Timsort only merges consecutive runs, this is needed to maintain stability, otherwise equal elements would be transferred between runs. Also the first invariant makes sure that run lengths grow at least as fast as the Fibonacci numbers, giving an upper bound on the size of the run stack when we know the maximum array length.&lt;/p&gt;
&lt;p&gt;One can now see that already-sorted sequences are sorted in O(n) as such an array would result in a single run that does not need to get merged. The worst case is O(n log n). These algorithmic properties together with the stable nature of Timsort were a few of the reasons why we chose Timsort over Quicksort in the end.&lt;/p&gt;
&lt;h3 id=&quot;implementing-timsort-in-torque&quot;&gt;Implementing Timsort in Torque &lt;a class=&quot;bookmark&quot; href=&quot;#implementing-timsort-in-torque&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Builtins usually have different code-paths that are chosen during runtime depending on various variables. The most generic version can handle any kind of object, regardless if its a &lt;code&gt;JSProxy&lt;/code&gt;, has interceptors or needs to do prototype chain lookups when retrieving or setting properties.&lt;br&gt;
The generic path is rather slow in most cases, as it needs to account for all eventualities. But if we know upfront that the object to sort is a simple &lt;code&gt;JSArray&lt;/code&gt; containing only Smis, all these expensive &lt;code&gt;[[Get]]&lt;/code&gt; and &lt;code&gt;[[Set]]&lt;/code&gt; operations can be replaced by simple Loads and Stores to a &lt;code&gt;FixedArray&lt;/code&gt;. The main differentiator is the &lt;a href=&quot;https://v8.js.cn/blog/elements-kinds&quot;&gt;&lt;code&gt;ElementsKind&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The problem now becomes how to implement a fast-path. The core algorithm stays the same for all but the way we access elements changes based on the &lt;code&gt;ElementsKind&lt;/code&gt;. One way we could accomplish this is to dispatch to the correct â€œaccessorâ€ on each call-site. Imagine a switch for each â€œloadâ€/â€storeâ€ operation where we choose a different branch based on the chosen fast-path.&lt;/p&gt;
&lt;p&gt;Another solution (and this was the first approach tried) is to just copy the whole builtin once for each fast-path and inline the correct load/store access method. This approach turned out to be infeasible for Timsort as itâ€™s a big builtin and making a copy for each fast-path turned out to require 106 KB in total, which is way too much for a single builtin.&lt;/p&gt;
&lt;p&gt;The final solution is slightly different. Each load/store operation for each fast-path is put into its own â€œmini-builtinâ€. See the code example which shows the â€œloadâ€ operation for &lt;code&gt;FixedDoubleArray&lt;/code&gt;s.&lt;/p&gt;
&lt;pre class=&quot;language-torque&quot;&gt;&lt;code class=&quot;language-torque&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;Load&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;FastDoubleElements&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    context&lt;span class=&quot;token class-name&quot;&gt;: Context,&lt;/span&gt; sortState&lt;span class=&quot;token class-name&quot;&gt;: FixedArray,&lt;/span&gt; elements&lt;span class=&quot;token class-name&quot;&gt;: HeapObject,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    index&lt;span class=&quot;token class-name&quot;&gt;: Smi)&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;: Object {&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; elems&lt;span class=&quot;token class-name&quot;&gt;: FixedDoubleArray =&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;UnsafeCast&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;FixedDoubleArray&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elements&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; value&lt;span class=&quot;token class-name&quot;&gt;: float64 =&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;        LoadDoubleWithHoleCheck&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elems&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; index&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;otherwise&lt;/span&gt; Bailout&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; AllocateHeapNumberWithValue&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;label&lt;/span&gt; Bailout &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token comment&quot;&gt;// The pre-processing step removed all holes by compacting all elements&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token comment&quot;&gt;// at the start of the array. Finding a hole means the cmp function or&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token comment&quot;&gt;// ToString changes the array.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; Failure&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sortState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To compare, the most generic â€œloadâ€ operation is simply a call to &lt;code&gt;GetProperty&lt;/code&gt;. But while the above version generates efficient and fast machine code to load and convert a &lt;code&gt;Number&lt;/code&gt;, &lt;code&gt;GetProperty&lt;/code&gt; is a call to another builtin that could potentially involve a prototype chain lookup or invoke an accessor function.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;builtin Load&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ElementsAccessor &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; type&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    context&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sortState&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; FixedArray&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; elements&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HeapObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    index&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Smi&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Object &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; elements&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; index&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A fast-path then simply becomes a set of function pointers. This means we only need one copy of the core algorithm while setting up all relevant function pointers once upfront. While this greatly reduces the needed code space (down to 20k) it comes at the cost of an indirect branch at each access site. This is even exacerbated by the recent change to use &lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;embedded builtins&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;sort-state&quot;&gt;Sort state &lt;a class=&quot;bookmark&quot; href=&quot;#sort-state&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/sort-state.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;The picture above shows the â€œsort stateâ€. Itâ€™s a &lt;code&gt;FixedArray&lt;/code&gt; that keeps track of all the things needed while sorting. Each time &lt;code&gt;Array#sort&lt;/code&gt; is called, such a sort state is allocated. Entry 4 to 7 are the set of function pointers discussed above that comprise a fast-path.&lt;/p&gt;
&lt;p&gt;The â€œcheckâ€ builtin is used every time we return from user JavaScript code, to check if we can continue on the current fast-path. It uses the â€œinitial receiver mapâ€ and â€œinitial receiver lengthâ€ for this.  Should the user code have modified the current object, we simply abandon the sorting run, reset all pointers to their most generic version and restart the sorting process. The â€œbailout statusâ€ in slot 8 is used to signal this reset.&lt;/p&gt;
&lt;p&gt;The â€œcompareâ€ entry can point to two different builtins. One calls a user-provided comparison function while the other implements the default comparison that calls &lt;code&gt;toString&lt;/code&gt; on both arguments and then does a lexicographical comparison.&lt;/p&gt;
&lt;p&gt;The rest of the fields (with the exception of the fast path ID) are Timsort-specific. The run stack (described above) is initialized with a size of 85 which is enough to sort arrays of length 2&lt;sup&gt;64&lt;/sup&gt;. The temporary array is used for merging runs. It grows in size as needed but never exceeds &lt;code&gt;n/2&lt;/code&gt; where &lt;code&gt;n&lt;/code&gt; is the input length.&lt;/p&gt;
&lt;h3 id=&quot;performance-trade-offs&quot;&gt;Performance trade-offs &lt;a class=&quot;bookmark&quot; href=&quot;#performance-trade-offs&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Moving sorting from self-hosted JavaScript to Torque comes with performance trade-offs. As &lt;code&gt;Array#sort&lt;/code&gt; is written in Torque, itâ€™s now a statically compiled piece of code, meaning we still can build fast-paths for certain &lt;a href=&quot;https://v8.js.cn/blog/elements-kinds&quot;&gt;&lt;code&gt;ElementsKind&lt;/code&gt;s&lt;/a&gt; but it will never be as fast as a highly optimized TurboFan version that can utilize type feedback. On the other hand, in cases where the code doesnâ€™t get hot enough to warrant JIT compilation or the call-site is megamorphic, we are stuck with the interpreter or a slow/generic version. The parsing, compiling and possible optimizing of the self-hosted JavaScript version is also an overhead that is not needed with the Torque implementation.&lt;/p&gt;
&lt;p&gt;While the Torque approach doesnâ€™t result in the same peak performance for sorting, it does avoid performance cliffs. The result is a sorting performance that is much more predictable than it previously was. Keep in mind that Torque is very much in flux and in addition of targeting CSA it might target TurboFan in the future, allowing JIT compilation of code written in Torque.&lt;/p&gt;
&lt;h3 id=&quot;microbenchmarks&quot;&gt;Microbenchmarks &lt;a class=&quot;bookmark&quot; href=&quot;#microbenchmarks&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Before we started with &lt;code&gt;Array#sort&lt;/code&gt;, we added a lot of different micro-benchmarks to get a better understanding of the impact the re-implementation would have. The first chart shows the â€œnormalâ€ use case of sorting various ElementsKinds with a user-provided comparison function.&lt;/p&gt;
&lt;p&gt;Keep in mind that in these cases the JIT compiler can do a lot of work, since sorting is nearly all we do. This also allows the optimizing compiler to inline the comparison function in the JavaScript version, while we have the call overhead from the builtin to JavaScript in the Torque case. Still, we perform better in nearly all cases.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/micro-bench-basic.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;The next chart shows the impact of Timsort when processing arrays that are already sorted completely, or have sub-sequences that are already sorted one-way or another. The chart uses Quicksort as a baseline and shows the speedup of Timsort (up to 17Ã— in the case of â€œDownDownâ€ where the array consists of two reverse-sorted sequences). As can be seen, expect in the case of random data, Timsort performs better in all other cases, even though we are sorting &lt;code&gt;PACKED_SMI_ELEMENTS&lt;/code&gt;, where Quicksort outperformed Timsort in the microbenchmark above.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/micro-bench-presorted.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;web-tooling-benchmark&quot;&gt;Web Tooling Benchmark &lt;a class=&quot;bookmark&quot; href=&quot;#web-tooling-benchmark&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/v8/web-tooling-benchmark&quot;&gt;Web Tooling Benchmark&lt;/a&gt; is a collection of workloads of tools usually used by web developers such as Babel and TypeScript. The chart uses JavaScript Quicksort as a baseline and compares the speedup of Timsort against it. In almost all benchmarks we retain the same performance with the exception of chai.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/array-sort/web-tooling-benchmark.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;The chai benchmark spends &lt;em&gt;a third&lt;/em&gt; of its time inside a single comparison function (a string distance calculation). The benchmark is the test suite of chai itself. Due to the data, Timsort needs some more comparisons in this case, which has a bigger impact on the overall runtime, as such a big portion of time is spent inside that particular comparison function.&lt;/p&gt;
&lt;h3 id=&quot;memory-impact&quot;&gt;Memory impact &lt;a class=&quot;bookmark&quot; href=&quot;#memory-impact&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Analyzing V8 heap snapshots while browsing some 50 sites (both on mobile as well as on desktop) didnâ€™t show any memory regressions or improvements. On the one hand, this is surprising: the switch from Quicksort to Timsort introduced the need for a temporary array for merging runs, which can grow much larger than the temporary arrays used for sampling. On the other hand, these temporary arrays are very short-lived (only for the duration of the &lt;code&gt;sort&lt;/code&gt; call) and can be allocated and discarded rather quickly in V8â€™s new space.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion &lt;a class=&quot;bookmark&quot; href=&quot;#conclusion&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In summary we feel much better about the algorithmic properties and the predictable performance behavior of a Timsort implemented in Torque. Timsort is available starting with V8 v7.0 and Chrome 70. Happy sorting!&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>åœ¨ V8 ä¸­ æå‡ `DataView` çš„æ€§èƒ½</title>
    <link href="https://v8.js.cn/blog/dataview"/>
    <updated>2018-09-18T11:20:37+00:00</updated>
    <id>https://v8.js.cn/blog/dataview</id>
    <author>
      <name>ThÃ©otime Grohens, le savant de Data-Vue, and Benedikt Meurer (@bmeurer), professional performance pal</name>
    </author>
    <content type="html">&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView&quot;&gt;&lt;code&gt;DataView&lt;/code&gt;&lt;/a&gt; æ˜¯åœ¨ JavaScript ä¸­è®¿é—®åº•å±‚å†…å­˜çš„ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼Œå¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray&quot;&gt;&lt;code&gt;TypedArray&lt;/code&gt;&lt;/a&gt;ã€‚ åœ¨è¿™ä¹‹å‰ï¼ŒV8 å¯¹ &lt;code&gt;DataView&lt;/code&gt; æ‰€åšçš„ä¼˜åŒ–è¿œé€Šäº &lt;code&gt;TypedArray&lt;/code&gt;ï¼Œå¯¼è‡´åœ¨å›¾åƒå¤„ç†å¯†é›†å‹æˆ–è§£ç /ç¼–ç äºŒè¿›åˆ¶æ•°æ®ç­‰ä»»åŠ¡ä¸­ï¼Œä½¿ç”¨ &lt;code&gt;DataView&lt;/code&gt; çš„ç¨‹åºæ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚é€ æˆè¿™ç§ç°è±¡ä¸»è¦æ˜¯å†å²åŸå› , ä¾‹å¦‚ &lt;a href=&quot;http://asmjs.org/&quot;&gt;asm.js&lt;/a&gt; åœ¨åº•å±‚å®ç°ä¸­é€‰æ‹©äº† &lt;code&gt;TypedArray&lt;/code&gt; è€Œä¸æ˜¯ &lt;code&gt;DataView&lt;/code&gt;, å› æ­¤ V8 æ›´ä¸“æ³¨äºä¼˜åŒ– &lt;code&gt;TypedArray&lt;/code&gt; çš„æ€§èƒ½.&lt;/p&gt;
&lt;p&gt;ç”±äºä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼ŒGoogle Maps ç­‰å›¢é˜Ÿä¸­çš„ JavaScript å¼€å‘è€…å†³å®šé¿å…ä½¿ç”¨ &lt;code&gt;DataView&lt;/code&gt;ï¼Œè½¬è€Œä½¿ç”¨ &lt;code&gt;TypedArray&lt;/code&gt;ï¼Œä½†æ˜¯è¿™æ ·åšä¼šä½¿ä»£ç å¤æ‚æ€§å¢åŠ ã€‚ åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç€é‡é˜è¿° &lt;a href=&quot;https://v8.js.cn/blog/v8-release-69&quot;&gt;V8 v6.9&lt;/a&gt; å¦‚ä½•ä¼˜åŒ– &lt;code&gt;DataView&lt;/code&gt; çš„æ€§èƒ½ï¼Œæ¥è®©å®ƒæ‹¥æœ‰å¯ä»¥ä¸ &lt;code&gt;TypedArray&lt;/code&gt; åŒ¹æ•Œçš„æ€§èƒ½ï¼Œå¹¶èƒ½å¤Ÿè¢«åº”ç”¨äºçœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&quot;background&quot;&gt;èƒŒæ™¯ &lt;a class=&quot;bookmark&quot; href=&quot;#background&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ES2015 æ¨å‡ºä¹‹åï¼ŒJavaScript å¼€å§‹æ”¯æŒåœ¨åŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºä¸­è¯»å–å’Œå†™å…¥æ•°æ®ï¼Œè¿™ä¸ªç¼“å†²åŒºè¢«ç§°ä¸º &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer&quot;&gt;&lt;code&gt;ArrayBuffer&lt;/code&gt;&lt;/a&gt; ã€‚&lt;code&gt;ArrayBuffer&lt;/code&gt; æ— æ³•é€šè¿‡ç¨‹åºç›´æ¥è®¿é—®, æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;em&gt;æ•°ç»„ç¼“å†²åŒºè§†å›¾&lt;/em&gt;å¯¹è±¡æ¥é—´æ¥è®¿é—®ï¼Œè€Œ &lt;code&gt;DataView&lt;/code&gt; å’Œ &lt;code&gt;TypedArray&lt;/code&gt; å°±æ˜¯ä¸¤ç§æ•°ç»„ç¼“å†²åŒºè§†å›¾å¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;TypedArray&lt;/code&gt; å…è®¸ç¨‹åºä»¥ç»Ÿä¸€çš„ç±»å‹æ•°ç»„çš„å½¢å¼è®¿é—®ç¼“å†²åŒºï¼Œä¾‹å¦‚ &lt;code&gt;Int16Array&lt;/code&gt; æˆ– &lt;code&gt;Float32Array&lt;/code&gt; ã€‚&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; buffer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ArrayBuffer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; array &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Int16Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  array&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;array&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// â†’ [0, 1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¦ä¸€æ–¹é¢ï¼Œ&lt;code&gt;DataView&lt;/code&gt; åˆ™å…è®¸æ›´ç»†ç²’åº¦çš„æ•°æ®è®¿é—®ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºæ¯ç§å€¼ç±»å‹æä¾›ä¸“é—¨çš„ getter å’Œ setter æ¥é€‰æ‹©ä»ç¼“å†²åŒºè¯»å–å’Œå†™å…¥çš„å€¼çš„ç±»å‹ï¼Œè¿™ä½¿å¾— &lt;code&gt;DateView&lt;/code&gt; å¯ç”¨äºåºåˆ—åŒ–æ•°æ®ç»“æ„ã€‚&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; buffer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ArrayBuffer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; view &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataView&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; person &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; age&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; height&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1.76&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setUint8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; person&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;age&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setFloat64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; person&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getUint8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// æœŸæœ›è¾“å‡º: 42&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFloat64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// æœŸæœ›è¾“å‡º: 1.76&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ­¤å¤–ï¼Œ&lt;code&gt;DataView&lt;/code&gt; è¿˜å…è®¸å¼€å‘è€…é€‰æ‹©æ•°æ®å­˜å‚¨çš„å­—èŠ‚é¡ºåºï¼Œè¿™ç‚¹åœ¨ä»å¤–éƒ¨æºï¼ˆå¦‚ç½‘ç»œï¼Œæ–‡ä»¶æˆ– GPU ä¸­ï¼‰æ¥æ”¶æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; buffer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ArrayBuffer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; view &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DataView&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setInt32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8BADF00D&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// å°ç«¯åºå†™å…¥.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;view&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getInt32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// å¤§ç«¯åºè¯»å‡º.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// æœŸæœ›è¾“å‡º: 0x0DF0AD8B (233876875)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¾ˆé•¿æ—¶é—´ä»¥æ¥ï¼Œå®ç°ä¸€ä¸ªé«˜æ•ˆçš„ &lt;code&gt;DataView&lt;/code&gt; çš„å‘¼å£°ä¸€ç›´å¾ˆé«˜ï¼ˆå‚è§5å¹´å‰çš„ &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=225811&quot;&gt;bug æŠ¥å‘Š&lt;/a&gt;)ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒï¼š DataView çš„æ€§èƒ½ç°å·²ç»å¾—åˆ°å¤§å¹…æå‡ï¼&lt;/p&gt;
&lt;h2 id=&quot;legacy-runtime-implemention&quot;&gt;ä¼ ç»Ÿçš„è¿è¡Œæ—¶å®ç° &lt;a class=&quot;bookmark&quot; href=&quot;#legacy-runtime-implemention&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;åœ¨æ­¤ä¹‹å‰ï¼Œ&lt;code&gt;DataView&lt;/code&gt; æ–¹æ³•åœ¨ V8 ä¸­æ˜¯å†…ç½®çš„ C++ è¿è¡Œæ—¶å‡½æ•°ã€‚è¿™ç§å‡½æ•°çš„è°ƒç”¨æˆæœ¬éå¸¸é«˜æ˜‚ï¼Œå› ä¸ºæ¯ä¸€æ¬¡è·¨è¯­è¨€è°ƒç”¨ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨ C++ å’Œ JavaScript ä¹‹é—´è¿›è¡Œä¿¡æ¯çš„è½¬æ¢ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†ç ”ç©¶è¿™ä¸ªå®ç°å®é™…çš„æ€§èƒ½æŸè€—ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œå°†åŸç”Ÿçš„ &lt;code&gt;DataView&lt;/code&gt; getter å®ç°ä¸æ¨¡æ‹Ÿ &lt;code&gt;DataView&lt;/code&gt; è¡Œä¸ºçš„ JavaScript åŒ…è£…å‡½æ•°è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªåŒ…è£…å‡½æ•°ä½¿ç”¨ &lt;code&gt;Uint8Array&lt;/code&gt; ä»åº•å±‚ç¼“å†²åŒºé€å­—èŠ‚è¯»å–æ•°æ®ï¼Œç„¶ååˆ©ç”¨è¿™äº›å­—èŠ‚è®¡ç®—å‡ºè¿”å›å€¼ã€‚ä¸‹é¢æ˜¯è¯»å–å°ç«¯åº32ä½æ— ç¬¦å·æ•´æ•°å€¼çš„å‡½æ•°ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;LittleEndian&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// æ¨¡æ‹Ÿå°ç«¯åºçš„ DataView æ•°æ®è¯»å–.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uint8View_ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Uint8Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;LittleEndian&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;getUint32&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byteOffset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uint8View_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;byteOffset&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uint8View_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;byteOffset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uint8View_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;byteOffset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uint8View_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;byteOffset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ V8 ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯¹ &lt;code&gt;TypedArray&lt;/code&gt; è¿›è¡Œäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå› æ­¤å®ƒä»¬çš„æ€§èƒ½å°±æ˜¯äº†æˆ‘ä»¬æƒ³è¦è¿½èµ¶çš„ç›®æ ‡ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/dataview/dataview-original.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;åŸå§‹ &lt;code&gt;DataView&lt;/code&gt; æ€§èƒ½&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;æˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•æ˜¾ç¤ºï¼Œåœ¨å¤§ç«¯åºå’Œå°ç«¯åºçš„æ•°æ®å­˜å–æµ‹è¯•ä¸­ï¼ŒåŸç”Ÿ &lt;code&gt;DataView&lt;/code&gt; getter çš„æ€§èƒ½å‡æ¯”åŸºäº &lt;code&gt;Uint8Array&lt;/code&gt; çš„åŒ…è£…å‡½æ•°ä½äº†&lt;strong&gt;4å€&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;improving-baseline-performance&quot;&gt;æå‡åŸºå‡†æ€§èƒ½ &lt;a class=&quot;bookmark&quot; href=&quot;#improving-baseline-performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;æƒ³è¦æé«˜ &lt;code&gt;DataView&lt;/code&gt; å¯¹è±¡çš„æ€§èƒ½ï¼Œæˆ‘ä»¬æ‰€åšçš„ç¬¬ä¸€æ­¥å°±æ˜¯å°†å®ƒçš„å®ç°ä» C++ è¿è¡Œæ—¶è½¬ç§»åˆ° &lt;a href=&quot;https://v8.js.cn/blog/csa&quot;&gt;&lt;code&gt;CodeStubAssembler&lt;/code&gt;ï¼ˆç®€ç§° CSAï¼‰&lt;/a&gt; ä¸­ã€‚CSA æ˜¯ä¸€ç§å¯ç§»æ¤çš„æ±‡ç¼–è¯­è¨€ï¼Œå®ƒå…è®¸æˆ‘ä»¬ç›´æ¥åœ¨ TurboFan çš„æœºå™¨çº§ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ä¸­ç¼–å†™ä»£ç ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ CSA æ¥å®ç° V8 ä¸­ JavaScript æ ‡å‡†åº“çš„ä¼˜åŒ–éƒ¨åˆ†ã€‚åœ¨ CSA ä¸­é‡å†™ä»£ç å¯ä»¥å®Œå…¨ç»•è¿‡å¯¹ C++ çš„è°ƒç”¨ï¼Œå¹¶åˆ©ç”¨ TurboFan çš„åç«¯æ¥ç”Ÿæˆé«˜æ•ˆçš„æœºå™¨ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶è€Œï¼Œæ‰‹åŠ¨ç¼–å†™ CSA ä»£ç éå¸¸çš„éº»çƒ¦ã€‚ CSA ä¸­çš„æ§åˆ¶æµä¸æ±‡ç¼–ä¸€æ ·ï¼Œä½¿ç”¨çš„æ˜¯æ˜¾å¼çš„æ ‡ç­¾å’Œ &lt;code&gt;goto&lt;/code&gt;ï¼Œè¿™ä½¿å¾—ä»£ç é˜…è¯»èµ·æ¥è¯˜å±ˆè±ç‰™ï¼Œæ™¦æ¶©éš¾æ‡‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´å®¹æ˜“åœ°ä¸º V8 JavaScript æ ‡å‡†åº“çš„ä¼˜åŒ–åšå‡ºè´¡çŒ®ï¼Œå¹¶æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œæˆ‘ä»¬å¼€å§‹è®¾è®¡ä¸€ç§åä¸º V8 &lt;em&gt;Torque&lt;/em&gt; çš„æ–°è¯­è¨€ï¼Œè¯¥è¯­è¨€å¯ç¼–è¯‘ä¸º CSA ã€‚&lt;em&gt;Torque&lt;/em&gt; çš„ç›®æ ‡æ˜¯æŠ½è±¡å‡º CSA ä»£ç ä¸­éš¾ä»¥ç¼–å†™å’Œç»´æŠ¤çš„ä½å±‚æ¬¡ç»†èŠ‚ï¼ŒåŒæ—¶ä¿æŒç›¸åŒçš„æ€§èƒ½è¡¨ç°ã€‚&lt;/p&gt;
&lt;p&gt;é‡å†™ &lt;code&gt;DataView&lt;/code&gt; çš„ä»£ç æ˜¯ä¸ªå°è¯•ä½¿ç”¨ Torque çš„ç»ä½³æœºä¼šï¼Œå¹¶ä¸”å¯ä»¥å‘ Torque çš„å¼€å‘è€…æä¾›è®¸å¤šç›¸å…³çš„åé¦ˆã€‚ä¸‹é¢è¿™ä¸ªå°±æ˜¯ç”¨ Torque ç¼–å†™çš„ &lt;code&gt;getUint32()&lt;/code&gt; å‡½æ•°ï¼š&lt;/p&gt;
&lt;pre class=&quot;language-torque&quot;&gt;&lt;code class=&quot;language-torque&quot;&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;macro&lt;/span&gt; LoadDataViewUint32&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token class-name&quot;&gt;: JSArrayBuffer,&lt;/span&gt; offset&lt;span class=&quot;token class-name&quot;&gt;: intptr,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;                    requested_little_endian&lt;span class=&quot;token class-name&quot;&gt;: bool,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;                    signed&lt;span class=&quot;token class-name&quot;&gt;: &lt;span class=&quot;token keyword&quot;&gt;constexpr&lt;/span&gt; bool)&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;: Number {&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; data_pointer&lt;span class=&quot;token class-name&quot;&gt;: RawPtr =&lt;/span&gt; buffer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;backing_store&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b0&lt;span class=&quot;token class-name&quot;&gt;: uint32 =&lt;/span&gt; LoadUint8&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data_pointer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b1&lt;span class=&quot;token class-name&quot;&gt;: uint32 =&lt;/span&gt; LoadUint8&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data_pointer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b2&lt;span class=&quot;token class-name&quot;&gt;: uint32 =&lt;/span&gt; LoadUint8&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data_pointer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b3&lt;span class=&quot;token class-name&quot;&gt;: uint32 =&lt;/span&gt; LoadUint8&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data_pointer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result&lt;span class=&quot;token class-name&quot;&gt;: uint32;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;requested_little_endian&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b3 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b1 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; b0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b0 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b1 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; b3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; convert&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Number&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;highlight-line&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å°† &lt;code&gt;DataView&lt;/code&gt; çš„æ–¹æ³•å®ç°è½¬ç§»åˆ° Torque ä¸Šå·²ç»åœ¨æ€§èƒ½ä¸Šæœ‰äº†&lt;strong&gt;3å€&lt;/strong&gt;çš„æå‡ï¼Œä½†è¿˜æ˜¯æ— æ³•ä¸åŸºäº &lt;code&gt;Uint8Array&lt;/code&gt; çš„åŒ…è£…å‡½æ•°ç›¸åª²ç¾ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/dataview/dataview-torque.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt; Torque ç¼–å†™çš„ &lt;code&gt;DataView&lt;/code&gt; æ€§èƒ½ &lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;optimizing-for-turbofan&quot;&gt;ä¼˜åŒ– TurboFan &lt;a class=&quot;bookmark&quot; href=&quot;#optimizing-for-turbofan&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;å½“ JavaScript ä»£ç è¢«æ‰§è¡Œå¤šæ¬¡åï¼Œæˆ‘ä»¬ä½¿ç”¨ TurboFan ä¼˜åŒ–ç¼–è¯‘å™¨å¯¹å…¶è¿›è¡ŒäºŒæ¬¡ç¼–è¯‘ï¼Œä»¥ç”Ÿæˆé«˜åº¦ä¼˜åŒ–çš„æœºå™¨ä»£ç ï¼Œè¯¥æœºå™¨ç æ¯”è§£é‡Šè¿è¡Œçš„å­—èŠ‚ç è¿è¡Œæ•ˆç‡æ›´é«˜ã€‚&lt;/p&gt;
&lt;p&gt;TurboFan çš„å·¥ä½œåŸç†æ˜¯å°†ä¼ å…¥çš„ JavaScript ä»£ç è½¬æ¢ä¸ºå†…éƒ¨çš„å›¾è¡¨ç¤ºï¼ˆæ›´ç¡®åˆ‡åœ°è¯´ï¼Œè¿™ç§å†…éƒ¨è¡¨ç¤ºå« &lt;a href=&quot;https://darksi.de/d.sea-of-nodes/&quot;&gt;â€œsea of nodesâ€&lt;/a&gt; ï¼‰ã€‚å®ƒä» JavaScript æ“ä½œå’Œè¯­ä¹‰çš„é«˜çº§èŠ‚ç‚¹å¼€å§‹ï¼Œé€æ¸å°†é«˜çº§èŠ‚ç‚¹ç»†åŒ–ä¸ºæ›´åº•å±‚çš„ä½çº§èŠ‚ç‚¹ï¼Œç›´åˆ°æœ€ç»ˆç”Ÿæˆæœºå™¨ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚ï¼Œå‡½æ•°è°ƒç”¨ï¼ˆä¾‹å¦‚è°ƒç”¨ä¸€ä¸ª &lt;code&gt;DataView&lt;/code&gt; çš„æ–¹æ³•ï¼‰åœ¨ TurboFan å†…éƒ¨è¡¨ç¤ºä¸º &lt;code&gt;JSCall&lt;/code&gt; èŠ‚ç‚¹ï¼Œå¹¶æœ€ç»ˆå½’çº¦æˆæœºå™¨ä»£ç ä¸­å®é™…çš„å‡½æ•°è°ƒç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼ŒTurboFan å…è®¸æˆ‘ä»¬æ£€æŸ¥ &lt;code&gt;JSCall&lt;/code&gt; èŠ‚ç‚¹æ˜¯å¦æ˜¯å¯¹å·²çŸ¥å‡½æ•°çš„è°ƒç”¨ï¼Œä¾‹å¦‚è°ƒç”¨å†…ç½®å‡½æ•°å°±æ˜¯å…¶ä¸­ä¸€ç§æƒ…å†µã€‚å¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ IR ä¸­å†…è”è¯¥å‡½æ•°è°ƒç”¨ã€‚è¿™æ„å‘³ç€å¤æ‚çš„ &lt;code&gt;JSCall&lt;/code&gt; åœ¨ç¼–è¯‘æ—¶è¢«å¯ä»¥è¢«å†…è”å±•å¼€ï¼Œ ä»è€Œä½¿ TurboFan å¯ä»¥åœ¨ä¹‹åçš„æµç¨‹ä¸­åœ¨æ›´å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¸­ç›´æ¥ä¼˜åŒ–è¿™ä¸ªå‡½æ•°å†…éƒ¨çš„ä»£ç ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿæ­¤é¿å…æ˜‚è´µçš„å‡½æ•°è°ƒç”¨å¼€é”€ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/dataview/dataview-turbofan-initial.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt; æœ€åˆçš„ TurboFan &lt;code&gt;DataView&lt;/code&gt; æ€§èƒ½ &lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;å®ç°äº† TurboFan çš„å‡½æ•°å†…è”ä¼˜åŒ–ä½¿ &lt;code&gt;DataView&lt;/code&gt; çš„æ€§èƒ½å¯ä»¥ä¸ &lt;code&gt;Uint8Array&lt;/code&gt; åŒ…è£…å‡½æ•°æ°ä¸€æ°æ‰‹è…•ï¼Œå¹¶ä¸”æ¯”æœ€åˆçš„ C++ å®ç°å¿« &lt;strong&gt;8å€&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;further-turbofan-optimizations&quot;&gt;è¿›ä¸€æ­¥çš„ TurboFan ä¼˜åŒ– &lt;a class=&quot;bookmark&quot; href=&quot;#further-turbofan-optimizations&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;åœ¨å†…è” &lt;code&gt;DataView&lt;/code&gt; æ–¹æ³•åï¼Œæˆ‘ä»¬æŸ¥çœ‹äº† TurboFan ç”Ÿæˆçš„æœºå™¨ä»£ç ï¼Œå‘ç°ä»ç„¶æœ‰ä¸€äº›æ”¹è¿›çš„ä½™åœ°ã€‚ &lt;code&gt;DataView&lt;/code&gt; æ–¹æ³•çš„ç¬¬ä¸€ç‰ˆå®ç°æ­£è¯•å›¾è´´è¿‘æ ‡å‡†è§„èŒƒï¼Œå¹¶åœ¨æŒ‡å®šçš„ä½ç½®æŠ›å‡ºé”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œå½“å¼€å‘è€…è¯•å›¾è¯»å–æˆ–å†™å…¥è¶…å‡ºåº•å±‚ &lt;code&gt;ArrayBuffer&lt;/code&gt; çš„è¾¹ç•Œæ—¶ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨ TurboFan ä¸­ç¼–å†™çš„ä»£ç ä¸»è¦æ˜¯ä¸ºäº†åœ¨é¢å¯¹å¸¸è§çš„æ‰§è¡Œæƒ…å†µæ—¶ï¼Œå¯ä»¥å°½å¿«è¿›è¡Œä»£ç ä¼˜åŒ– â€”â€” å®ƒä¸éœ€è¦æ”¯æŒæ‰€æœ‰å¯èƒ½çš„è¾¹ç¼˜æƒ…å†µã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ é™¤ä¸å¿…è¦çš„é”™è¯¯å¤„ç†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œåœ¨éœ€è¦æŠ›å‡ºé”™è¯¯æ—¶åªæ˜¯ç®€å•åœ°å›é€€è‡³éä¼˜åŒ–å®ç°çš„ Torque ä»£ç ï¼ˆå»ä¼˜åŒ–ï¼‰ï¼Œè¿™æ ·èƒ½å¤Ÿå°†ç”Ÿæˆçš„ä»£ç çš„å¤§å°å‡å°‘å¤§çº¦ 35ï¼…ï¼Œå¹¶æ˜¾è‘—æå‡ä»£ç æ‰§è¡Œé€Ÿåº¦ï¼Œä»¥åŠç”Ÿæˆæ›´ç®€æ´çš„ TurboFan ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;æ²¿ç€è¿™ä¸ªåœ¨ TurboFan ä¸­å°½å¯èƒ½ç‰¹åŒ–çš„æƒ³æ³•ï¼Œæˆ‘ä»¬è¿˜ç§»é™¤äº†å¯¹ä¼˜åŒ–ä»£ç ä¸­è¿‡å¤§ï¼ˆSmi ä¹‹å¤–ï¼‰çš„ç´¢å¼•æˆ–åç§»çš„æ”¯æŒã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ‘†è„±å¯¹ float64 ç®—æ³•ä¸­ä¸åˆé€‚çš„ 32 ä½åç§»çš„å¤„ç†ï¼Œå¹¶é¿å…åœ¨å †ä¸Šå­˜å‚¨å¤§æ•´æ•°ã€‚&lt;/p&gt;
&lt;p&gt;ä¸æœ€åˆçš„ TurboFan å®ç°ç›¸æ¯”ï¼Œè¿™é¡¹ä¼˜åŒ–ä½¿å¾— &lt;code&gt;DataView&lt;/code&gt; åŸºå‡†æµ‹è¯•åˆ†æ•°ç¿»äº†ä¸€å€è¿˜å¤šã€‚&lt;code&gt;DataView&lt;/code&gt; ç›®å‰çš„æ€§èƒ½æ˜¯ &lt;code&gt;Uint8Array&lt;/code&gt; åŒ…è£…å‡½æ•°çš„ 3 å€ï¼Œæ›´æ¯”åŸå§‹ &lt;code&gt;DataView&lt;/code&gt; è¿è¡Œé€Ÿåº¦çš„å¿«äº† &lt;strong&gt;16 å€&lt;/strong&gt;ä¹‹å¤šï¼&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/dataview/dataview-turbofan-final.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt; æœ€ç»ˆçš„ TurboFan &lt;code&gt;DataView&lt;/code&gt; æ€§èƒ½ &lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;impact&quot;&gt;å½±å“ &lt;a class=&quot;bookmark&quot; href=&quot;#impact&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;åŸºäºä¸Šé¢çš„åŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å·²ç»è¯„ä¼°äº† &lt;code&gt;DataView&lt;/code&gt; çš„æ–°å®ç°åœ¨ä¸€äº›çœŸå®ç¤ºä¾‹ä¸­çš„æ€§èƒ½å½±å“ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;DataView&lt;/code&gt; ç»å¸¸è¢«ç”¨æ¥è§£ç ä»¥äºŒè¿›åˆ¶æ ¼å¼ç¼–ç çš„æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œæœ‰ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼å« &lt;a href=&quot;https://en.wikipedia.org/wiki/FBX&quot;&gt;FBX&lt;/a&gt;ï¼Œå¸¸è¢«ç”¨äºäº¤æ¢ 3D åŠ¨ç”»ã€‚æˆ‘ä»¬å¯¹ä¸€ä¸ªå¾ˆå—æ¬¢è¿çš„ 3D JavaScript åº“ &lt;a href=&quot;https://threejs.org/&quot;&gt;three.js&lt;/a&gt; çš„ FBX åŠ è½½ç¨‹åºè¿›è¡Œäº†æ£€æµ‹ï¼Œå‘ç°å…¶ä»£ç æ‰§è¡Œæ—¶é—´ç¼©çŸ­äº†10ï¼…ï¼ˆçº¦80æ¯«ç§’ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å°† &lt;code&gt;DataView&lt;/code&gt; çš„æ•´ä½“æ€§èƒ½ä¸ &lt;code&gt;TypedArray&lt;/code&gt; è¿›è¡Œäº†æ¯”è¾ƒï¼Œç»“æœå‘ç°æ–°çš„ &lt;code&gt;DataView&lt;/code&gt; å®ç°ä¸ &lt;code&gt;TypedArray&lt;/code&gt; åœ¨æ€§èƒ½æ–¹é¢ä¸åˆ†ä¼¯ä»²ã€‚å°¤å…¶åœ¨è®¿é—®ä»¥åŸç”Ÿå­—èŠ‚é¡ºåºæ’åˆ—çš„æ•°æ®ï¼ˆè‹±ç‰¹å°”å¤„ç†å™¨ä¸Šçš„å°ç«¯ï¼‰æ—¶ï¼Œæ–°å®ç°å¼¥è¡¥ä¸Šäº†å¤§å¤šæ•°çš„æ€§èƒ½å·®è·ï¼Œå¹¶ä½¿&lt;code&gt;DataView&lt;/code&gt;æˆä¸ºäº† V8 ä¸Šçš„å®ç”¨ä¹‹é€‰ã€‚&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/dataview/dataview-vs-typedarray.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;&lt;code&gt;DataView&lt;/code&gt; vs. &lt;code&gt;TypedArray&lt;/code&gt; å³°å€¼æ€§èƒ½&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;æˆ‘ä»¬è¯šæŒšåœ°å¸Œæœ›å¼€å‘è€…å¯ä»¥å°è¯•ä½¿ç”¨æ–°çš„ &lt;code&gt;DataView&lt;/code&gt;ï¼Œè€Œä¸æ˜¯ä¾èµ–äºç”¨ &lt;code&gt;TypedArray&lt;/code&gt; å®ç°çš„ shimã€‚ è¯·å‘æˆ‘ä»¬å‘é€æœ‰å…³æ‚¨ä½¿ç”¨ &lt;code&gt;DataView&lt;/code&gt; çš„åé¦ˆï¼ æ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ &lt;a href=&quot;https://crbug.com/v8/new&quot;&gt;é”™è¯¯è·Ÿè¸ªå™¨&lt;/a&gt; ï¼Œæˆ–å°†é‚®ä»¶å‘é€åˆ°&lt;a href=&quot;mailto:v8-users@googlegroups.com&quot;&gt;v8-users@googlegroups.com&lt;/a&gt;ï¼Œæˆ–åœ¨ Twitter ä¸Š &lt;a href=&quot;https://v8.js.cn/blog/https%EF%BC%9A//twitter.com/v8js&quot;&gt;@ v8js&lt;/a&gt;ã€‚&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>Celebrating 10 years of V8</title>
    <link href="https://v8.js.cn/blog/10-years"/>
    <updated>2018-09-11T19:00:00+00:00</updated>
    <id>https://v8.js.cn/blog/10-years</id>
    <author>
      <name>Mathias Bynens (@mathias), V8 historian</name>
    </author>
    <content type="html">&lt;p&gt;This month marks the 10-year anniversary of shipping not just Google Chrome, but also the V8 project. This post gives an overview of major milestones for the V8 project in the past 10 years as well as the years before, when the project was still secret.&lt;/p&gt;
&lt;figure&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/G0vnrPTuxZA&quot; width=&quot;966&quot; height=&quot;543&quot;&gt;&lt;/iframe&gt;
  &lt;figcaption&gt;A visualization of the V8 code base over time, created using &lt;a href=&quot;http://gource.io/&quot;&gt;&lt;code&gt;gource&lt;/code&gt;&lt;/a&gt;.&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;before-v8-shipped%3A-the-early-years&quot;&gt;Before V8 shipped: the early years &lt;a class=&quot;bookmark&quot; href=&quot;#before-v8-shipped%3A-the-early-years&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Google hired &lt;a href=&quot;https://en.wikipedia.org/wiki/Lars_Bak_%28computer_programmer%29&quot;&gt;Lars Bak&lt;/a&gt; in the autumn of &lt;strong&gt;2006&lt;/strong&gt; to build a new JavaScript engine for the Chrome web browser, which at the time was still a secret internal Google project. Lars had recently moved back to Aarhus, Denmark, from Silicon Valley. Since there was no Google office there and Lars wanted to remain in Denmark, Lars and several of the projectâ€™s original engineers began working on the project in an outbuilding on his farm. The new JavaScript runtime was christened â€œV8â€, a playful reference to the powerful engine you can find in a classic muscle car. Later, when the V8 team had grown, the developers moved from their modest quarters to a modern office building in Aarhus, but the team took with them their singular drive and focus on building the fastest JavaScript runtime on the planet.&lt;/p&gt;
&lt;h2 id=&quot;launching-and-evolving-v8&quot;&gt;Launching and evolving V8 &lt;a class=&quot;bookmark&quot; href=&quot;#launching-and-evolving-v8&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;V8 went open-source the same day &lt;a href=&quot;https://blog.chromium.org/2008/09/welcome-to-chromium_02.html&quot;&gt;Chrome was launched&lt;/a&gt;: on September 2nd, &lt;strong&gt;2008&lt;/strong&gt;. &lt;a href=&quot;https://chromium.googlesource.com/v8/v8/+/43d26ecc3563a46f62a0224030667c8f8f3f6ceb&quot;&gt;The initial commit&lt;/a&gt; dates back to June 30th, 2008. Prior to that date, V8 development happened in a private CVS repository. Initially, V8 supported only the ia32 and ARM instruction sets and used &lt;a href=&quot;https://scons.org/&quot;&gt;SCons&lt;/a&gt; as its build system.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2009&lt;/strong&gt; saw the introduction of a brand new regular expression engine named &lt;a href=&quot;https://blog.chromium.org/2009/02/irregexp-google-chromes-new-regexp.html&quot;&gt;Irregexp&lt;/a&gt;, resulting in performance improvements for real-world regular expressions. With the introduction of an x64 port, the number of supported instruction sets increased from two to three. 2009 also marked &lt;a href=&quot;https://github.com/nodejs/node-v0.x-archive/releases/tag/v0.0.1&quot;&gt;the first release of the Node.js project&lt;/a&gt;, which embeds V8. The possibility for non-browser projects to embed V8 was &lt;a href=&quot;https://www.google.com/googlebooks/chrome/big_16.html&quot;&gt;explicitly mentioned&lt;/a&gt; in the original Chrome comic. With Node.js, it actually happened! Node.js grew to be one of the most popular JavaScript ecosystems.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2010&lt;/strong&gt; witnessed a big boost in runtime performance as V8 introduced a brand-new optimizing JIT compiler. &lt;a href=&quot;https://blog.chromium.org/2010/12/new-crankshaft-for-v8.html&quot;&gt;Crankshaft&lt;/a&gt; generated machine code that was twice as fast and 30% smaller than the previous (unnamed) V8 compiler. That same year, V8 added its fourth instruction set: 32-bit MIPS.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2011&lt;/strong&gt; came, and garbage collection was vastly improved. &lt;a href=&quot;https://blog.chromium.org/2011/11/game-changer-for-interactive.html&quot;&gt;A new incremental garbage collector&lt;/a&gt; drastically reduced pause times while maintaining great peak performance and low memory usage. V8 introduced the concept of Isolates, which allows embedders to spin up multiple instances of the V8 runtime in a process, paving the way for lighter-weight Web Workers in Chrome. The first of V8â€™s two build system migrations occurred as we transitioned from SCons to &lt;a href=&quot;https://gyp.gsrc.io/&quot;&gt;GYP&lt;/a&gt;. We implemented support for ES5 strict mode. Meanwhile, development moved from Aarhus to Munich (Germany) under new leadership with lots of cross-pollination from the original team in Aarhus.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2012&lt;/strong&gt; was a year of benchmarks for the V8 project. The team did speed sprints to optimize V8â€™s performance as measured through the &lt;a href=&quot;https://webkit.org/perf/sunspider/sunspider.html&quot;&gt;Sunspider&lt;/a&gt; and &lt;a href=&quot;https://krakenbenchmark.mozilla.org/&quot;&gt;Kraken&lt;/a&gt; benchmark suites. Later, we developed a new benchmark suite named &lt;a href=&quot;https://chromium.github.io/octane/&quot;&gt;Octane&lt;/a&gt; (with &lt;a href=&quot;http://www.netchain.com/Tools/v8/&quot;&gt;V8 Bench&lt;/a&gt; at its core) that brought peak performance competition to the forefront and spurred massive improvements in runtime and JIT technology in all major JS engines. One outcome of these efforts was the switch from randomized sampling to a deterministic, count-based technique for detecting â€œhotâ€ functions in V8â€™s runtime profiler. This made it significantly less likely that some page loads (or benchmark runs) would randomly be much slower than others.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2013&lt;/strong&gt; witnessed the appearance of a low-level subset of JavaScript named &lt;a href=&quot;http://asmjs.org/&quot;&gt;asm.js&lt;/a&gt;. Since asm.js is limited to statically-typed arithmetic, function calls, and heap accesses with primitive types only, validated asm.js code could run with predictable performance. We released a new version of Octane, &lt;a href=&quot;https://blog.chromium.org/2013/11/announcing-octane-20.html&quot;&gt;Octane 2.0&lt;/a&gt; with updates to existing benchmarks as well as new benchmarks that target use cases like asm.js. Octane spurred the development of new compiler optimizations like &lt;a href=&quot;https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42478.pdf&quot;&gt;allocation folding&lt;/a&gt; and &lt;a href=&quot;https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43823.pdf&quot;&gt;allocation-site-based optimizations for type transitioning and pretenuring&lt;/a&gt; that vastly improved peak performance. As part of an effort we internally nicknamed â€œHandlepocalypseâ€, the V8 Handle API was completely rewritten to make it easier to use correctly and safely. Also in 2013, Chromeâ€™s implementation of &lt;code&gt;TypedArray&lt;/code&gt;s in JavaScript was &lt;a href=&quot;https://codereview.chromium.org/13064003&quot;&gt;moved from Blink to V8&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In &lt;strong&gt;2014&lt;/strong&gt;, V8 moved some of the work of JIT compilation off the main thread with &lt;a href=&quot;https://blog.chromium.org/2014/02/compiling-in-background-for-smoother.html&quot;&gt;concurrent compilation&lt;/a&gt;, reducing jank and significantly improving performance. Later that year, we &lt;a href=&quot;https://github.com/v8/v8/commit/a1383e2250dc5b56b777f2057f1600537f02023e&quot;&gt;landed&lt;/a&gt; the initial version of a new optimizing compiler named TurboFan. Meanwhile, our partners helped port V8 to three new instruction set architectures: PPC, MIPS64, and ARM64. Following Chromium, V8 transitioned to yet another build system, &lt;a href=&quot;https://gn.googlesource.com/gn/#gn&quot;&gt;GN&lt;/a&gt;. The V8 testing infrastructure saw significant improvements, with a &lt;em&gt;Tryserver&lt;/em&gt; now available to test each patch on various build bots before landing. For source control, V8 migrated from SVN to Git.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2015&lt;/strong&gt; was a busy year for V8 on a number of fronts. We implemented &lt;a href=&quot;https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html&quot;&gt;code caching and script streaming&lt;/a&gt;, significantly speeding up web page load times. Work on our runtime systemâ€™s use of allocation mementos was &lt;a href=&quot;https://ai.google/research/pubs/pub43823&quot;&gt;published in ISMM 2015&lt;/a&gt;. Later that year, we &lt;a href=&quot;https://github.com/v8/v8/commit/7877c4e0c77b5c2b97678406eab7e9ad6eba4a4d&quot;&gt;kicked off&lt;/a&gt; the work on a new interpreter named Ignition. We experimented with the idea of subsetting JavaScript with &lt;a href=&quot;https://docs.google.com/document/d/1Qk0qC4s_XNCLemj42FqfsRLp49nDQMZ1y7fwf5YjaI4/view&quot;&gt;strong mode&lt;/a&gt; to achieve stronger guarantees and more predictable performance. We implemented strong mode behind a flag, but later found its benefits did not justify the costs. The addition of a &lt;a href=&quot;https://dev.chromium.org/developers/testing/commit-queue&quot;&gt;commit queue&lt;/a&gt; made big improvements in productivity and stability. V8â€™s garbage collector also began cooperating with embedders such as Blink to schedule garbage collection work during idle periods. &lt;a href=&quot;https://v8.js.cn/blog/free-garbage-collection&quot;&gt;Idle-time garbage collection&lt;/a&gt; significantly reduced observable garbage collection jank and memory consumption. In December, &lt;a href=&quot;https://github.com/titzer/v8-native-prototype&quot;&gt;the first WebAssembly prototype&lt;/a&gt; landed in V8.&lt;/p&gt;
&lt;p&gt;In &lt;strong&gt;2016&lt;/strong&gt;, we shipped the last pieces of the ES2015 (previously known as â€œES6â€) feature set (including promises, class syntax, lexical scoping, destructuring, and more), as well as some ES2016 features. We also started rolling out the new Ignition and TurboFan pipeline, using it to &lt;a href=&quot;https://v8.js.cn/blog/v8-release-56&quot;&gt;compile and optimize ES2015 and ES2016 features&lt;/a&gt;, and shipping Ignition by default for &lt;a href=&quot;https://v8.js.cn/blog/ignition-interpreter&quot;&gt;low-end Android devices&lt;/a&gt;. Our successful work on idle-time garbage collection was presented at &lt;a href=&quot;https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45361.pdf&quot;&gt;PLDI 2016&lt;/a&gt;. We kicked off &lt;a href=&quot;https://v8.js.cn/blog/orinoco&quot;&gt;the Orinoco project&lt;/a&gt;, a new mostly-parallel and concurrent garbage collector for V8 to reduce main thread garbage collection time. In a major refocus, we shifted our performance efforts away from synthetic micro-benchmarks and instead began to seriously measure and optimize &lt;a href=&quot;https://v8.js.cn/blog/real-world-performance&quot;&gt;real-world performance&lt;/a&gt;. For debugging, the V8 inspector was &lt;a href=&quot;https://v8.js.cn/blog/v8-release-55&quot;&gt;migrated&lt;/a&gt; from Chromium to V8, allowing any V8 embedder (and not just Chromium) to use the Chrome DevTools to debug JavaScript running in V8. The WebAssembly prototype graduated from prototype to experimental support, in coordination with other browser vendors &lt;a href=&quot;https://v8.js.cn/blog/webassembly-experimental&quot;&gt;experimental support for WebAssembly&lt;/a&gt;. V8 received &lt;a href=&quot;http://www.sigplan.org/Awards/Software/&quot;&gt;the ACM SIGPLAN Programming Languages Software Award&lt;/a&gt;. And another port was added: S390.&lt;/p&gt;
&lt;p&gt;In &lt;strong&gt;2017&lt;/strong&gt;, we finally completed our multi-year overhaul of the engine, enabling the new &lt;a href=&quot;https://v8.js.cn/blog/launching-ignition-and-turbofan&quot;&gt;Ignition and TurboFan&lt;/a&gt; pipeline by default. This made it possible to later remove Crankshaft (&lt;a href=&quot;https://chromium-review.googlesource.com/c/v8/v8/+/547717&quot;&gt;130,380 deleted lines of code&lt;/a&gt;) and &lt;a href=&quot;https://chromium-review.googlesource.com/c/v8/v8/+/584773&quot;&gt;Full-codegen&lt;/a&gt; from the codebase. We launched Orinoco v1.0, including &lt;a href=&quot;https://v8.js.cn/blog/concurrent-marking&quot;&gt;concurrent marking&lt;/a&gt;, concurrent sweeping, parallel scavenging, and parallel compaction. We officially recognized Node.js as a first-class V8 embedder alongside Chromium. Since then, itâ€™s impossible for a V8 patch to land if doing so breaks the Node.js test suite. Our infrastructure gained support for correctness fuzzing, ensuring that any piece of code produces consistent results regardless of the configuration it runs in.&lt;/p&gt;
&lt;p&gt;In an industry-wide coordinated launch, V8 &lt;a href=&quot;https://v8.js.cn/blog/v8-release-57&quot;&gt;shipped WebAssembly on-by-default&lt;/a&gt;. We implemented support for &lt;a href=&quot;https://developers.google.com/web/fundamentals/primers/modules&quot;&gt;JavaScript modules&lt;/a&gt; as well as the full ES2017 and ES2018 feature sets (including async functions, shared memory, async iteration, rest/spread properties, and RegExp features). We shipped &lt;a href=&quot;https://v8.js.cn/blog/javascript-code-coverage&quot;&gt;native support for JavaScript code coverage&lt;/a&gt;, and launched the &lt;a href=&quot;https://v8.js.cn/blog/web-tooling-benchmark&quot;&gt;Web Tooling Benchmark&lt;/a&gt; to help us measure how V8â€™s optimizations impact performance for real-world developer tools and the JavaScript output they generate. &lt;a href=&quot;https://v8.js.cn/blog/tracing-js-dom&quot;&gt;Wrapper tracing&lt;/a&gt; from JavaScript objects to C++ DOM objects and back allowed us to resolve long-standing memory leaks in Chrome and to handle the transitive closure of objects over the JavaScript and Blink heap efficiently. We later used this infrastructure to increase the capabilities of the heap snapshotting developer tool.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2018&lt;/strong&gt; saw an industry-wide security event upend what we thought we knew about CPU information security with the public disclosure of &lt;a href=&quot;https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html&quot;&gt;the Spectre/Meltdown vulnerabilities&lt;/a&gt;. V8 engineers performed extensive offensive research to help understand the threat for managed languages and develop mitigations. V8 shipped &lt;a href=&quot;https://v8.js.cn/docs/untrusted-code-mitigations&quot;&gt;mitigations&lt;/a&gt; against Spectre and similar side-channel attacks for embedders that run untrusted code.&lt;/p&gt;
&lt;p&gt;Recently, we shipped a baseline compiler for WebAssembly named &lt;a href=&quot;https://v8.js.cn/blog/liftoff&quot;&gt;Liftoff&lt;/a&gt; which greatly reduces startup time for WebAssembly applications while still achieving predictable performance. We shipped &lt;a href=&quot;https://v8.js.cn/blog/bigint&quot;&gt;&lt;code&gt;BigInt&lt;/code&gt;&lt;/a&gt;, a new JavaScript primitive that enables &lt;a href=&quot;https://developers.google.com/web/updates/2018/05/bigint&quot;&gt;arbitrary-precision integers&lt;/a&gt;. We implemented &lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;embedded builtins&lt;/a&gt;, and made it possible to &lt;a href=&quot;https://v8.js.cn/blog/lazy-deserialization&quot;&gt;lazily deserialize them&lt;/a&gt;, significantly reducing V8â€™s footprint for multiple Isolates. We made it possible to &lt;a href=&quot;https://v8.js.cn/blog/background-compilation&quot;&gt;compile script bytecode on a background thread&lt;/a&gt;. We started &lt;a href=&quot;https://docs.google.com/presentation/d/12ZkJ0BZ35fKXtpM342PmKM5ZSxPt03_wsRgbsJYl3Pc&quot;&gt;the Unified V8-Blink Heap project&lt;/a&gt; to run a cross-component V8 and Blink garbage collection in sync. And the yearâ€™s not over yetâ€¦&lt;/p&gt;
&lt;h2 id=&quot;performance-ups-and-downs&quot;&gt;Performance ups and downs &lt;a class=&quot;bookmark&quot; href=&quot;#performance-ups-and-downs&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Chromeâ€™s V8 Bench score over the years shows the performance impact of V8â€™s changes. (Weâ€™re using the V8 Bench because itâ€™s one of the few benchmarks that can still run in the original Chrome beta.)&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/10-years/v8-bench.png&quot; srcset=&quot;https://v8.js.cn/_img/10-years/v8-bench@2x.png 2x&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Chromeâ€™s &lt;a href=&quot;http://www.netchain.com/Tools/v8/&quot;&gt;V8 Bench&lt;/a&gt; score from 2008 to 2018&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Our score on this benchmark went up &lt;strong&gt;4Ã—&lt;/strong&gt; over the last ten years!&lt;/p&gt;
&lt;p&gt;However, you might notice two performance dips over the years. Both are interesting because they correspond to significant events in V8â€™s history. The performance drop in 2015 happened when V8 shipped baseline versions of ES2015 features. These features were cross-cutting in the V8 code base, and we therefore focused on correctness rather than performance for their initial release. We accepted these slight speed regressions to get features to developers as quickly as possible. In early 2018, the Spectre vulnerability was disclosed, and V8 shipped mitigations to protect users against potential exploits, resulting in another regression in performance. Luckily, now that Chrome is shipping &lt;a href=&quot;https://developers.google.com/web/updates/2018/07/site-isolation&quot;&gt;Site Isolation&lt;/a&gt;, we can disable the mitigations again, bringing performance back on par.&lt;/p&gt;
&lt;p&gt;Another take-away from this chart is that it starts to level off around 2013. Does that mean V8 gave up and stopped investing in performance? Quite the opposite! The flattening of the graphs represents the V8 teamâ€™s pivot from synthetic micro-benchmarks (such as V8 Bench and Octane) to optimizing for &lt;a href=&quot;https://v8.js.cn/blog/real-world-performance&quot;&gt;real-world performance&lt;/a&gt;. V8 Bench is an old benchmark that doesnâ€™t use any modern JavaScript features, nor does it approximate actual real-world production code. Contrast this with the more recent Speedometer benchmark suite:&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/10-years/speedometer-1.png&quot; srcset=&quot;https://v8.js.cn/_img/10-years/speedometer-1@2x.png 2x&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Chromeâ€™s &lt;a href=&quot;https://browserbench.org/Speedometer/&quot;&gt;Speedometer 1&lt;/a&gt; score from 2013 to 2018&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Although V8 Bench shows minimal improvements from 2013 to 2018, our Speedometer 1 score went up (another) &lt;strong&gt;4Ã—&lt;/strong&gt; during this same time period. (We used Speedometer 1 because Speedometer 2 uses modern JavaScript features that werenâ€™t yet supported in 2013.)&lt;/p&gt;
&lt;p&gt;Nowadays, we have &lt;a href=&quot;https://v8.js.cn/blog/speedometer-2&quot;&gt;even better&lt;/a&gt; &lt;a href=&quot;https://v8.js.cn/blog/web-tooling-benchmark&quot;&gt;benchmarks&lt;/a&gt; that more accurately reflect modern JavaScript apps, and on top of that, we &lt;a href=&quot;https://www.youtube.com/watch?v=xCx4uC7mn6Y&quot;&gt;actively measure and optimize for existing web apps&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;summary&quot;&gt;Summary &lt;a class=&quot;bookmark&quot; href=&quot;#summary&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Although V8 was originally built for Google Chrome, it has always been a stand-alone project with a separate codebase and an embedding API that allows any program to use its JavaScript execution services. Over the last 10 years, the open nature of the project has helped it become a key technology not only for the Web Platform, but in other contexts like Node.js as well. Along the way the project evolved and remained relevant despite many changes and dramatic growth.&lt;/p&gt;
&lt;p&gt;Initially, V8 supported only two instruction sets. In the last 10 years the list of supported platforms reached eight: ia32, x64, ARM, ARM64, 32- and 64-bit MIPS, 64-bit PPC, and S390. V8â€™s build system migrated from SCons to GYP to GN. The project moved from Denmark to Germany, and now has engineers all over the world, including in London, Mountain View, and San Francisco, with contributors outside of Google from many more places. Weâ€™ve transformed our entire JavaScript compilation pipeline from unnamed components to Full-codegen (a baseline compiler) and Crankshaft (an feedback-driven optimizing compiler) to Ignition (an interpreter) and TurboFan (a better feedback-driven optimizing compiler). V8 went from being â€œjustâ€ a JavaScript engine to also supporting WebAssembly. The JavaScript language itself evolved from ECMAScript 3 to ES2018; the latest V8 even implements post-ES2018 features.&lt;/p&gt;
&lt;p&gt;The story arc of Web is a long and enduring one. Celebrating Chrome and V8â€™s 10th birthday is a good opportunity to reflect that even though this is a big milestone, the Web Platformâ€™s narrative has lasted for more than 25 years. We have no doubt the Webâ€™s story will continue for at least that long in the future. Weâ€™re committed to making sure that V8, JavaScript, and WebAssembly continue to be interesting characters in that narrative. Weâ€™re excited to see what the next decade has in store. Stay tuned!&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>Liftoff: a new baseline compiler for WebAssembly in V8</title>
    <link href="https://v8.js.cn/blog/liftoff"/>
    <updated>2018-08-20T15:45:12+00:00</updated>
    <id>https://v8.js.cn/blog/liftoff</id>
    <author>
      <name>Clemens Hammacher, WebAssembly compilation maestro</name>
    </author>
    <content type="html">&lt;p&gt;V8 &lt;a href=&quot;https://v8.js.cn/blog/v8-release-69&quot;&gt;v6.9&lt;/a&gt; includes Liftoff, a new baseline compiler for WebAssembly. Liftoff is now enabled by default on desktop systems. This article details the motivation to add another compilation tier and describes the implementation and performance of Liftoff.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-liftoff.svg&quot; width=&quot;256&quot; height=&quot;256&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Logo for Liftoff, V8â€™s WebAssembly baseline compiler&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Since WebAssembly &lt;a href=&quot;https://v8.js.cn/blog/v8-release-57&quot;&gt;launched&lt;/a&gt; more than a year ago, adoption on the web has been steadily increasing. Big applications targeting WebAssembly have started to appear. For example, Epicâ€™s &lt;a href=&quot;https://s3.amazonaws.com/mozilla-games/ZenGarden/EpicZenGarden.html&quot;&gt;ZenGarden benchmark&lt;/a&gt; comprises a 39.5 MB WebAssembly binary, and &lt;a href=&quot;https://web.autocad.com/&quot;&gt;AutoDesk&lt;/a&gt; ships as a 36.8 MB binary. Since compilation time is essentially linear in the binary size, these applications take a considerable time to start up. On many machines itâ€™s more than 30 seconds, which does not provide a great user experience.&lt;/p&gt;
&lt;p&gt;But why does it take this long to start up a WebAssembly app, if similar JS apps start up much faster? The reason is that WebAssembly promises to deliver &lt;em&gt;predictable performance&lt;/em&gt;, so once the app is running, you can be sure to consistently meet your performance goals (e.g. rendering 60 frames per second, no audio lag or artifactsâ€¦). In order to achieve this, WebAssembly code is compiled &lt;em&gt;ahead of time&lt;/em&gt; in V8, to avoid any compilation pause introduced by a just-in-time compiler that could result in visible jank in the app.&lt;/p&gt;
&lt;h2 id=&quot;the-existing-compilation-pipeline-(turbofan)&quot;&gt;The existing compilation pipeline (TurboFan) &lt;a class=&quot;bookmark&quot; href=&quot;#the-existing-compilation-pipeline-(turbofan)&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;V8â€™s approach to compiling WebAssembly has relied on &lt;em&gt;TurboFan&lt;/em&gt;, the optimizing compiler we designed for JavaScript and asm.js. TurboFan is a powerful compiler with a graph-based &lt;em&gt;intermediate representation (IR)&lt;/em&gt; suitable for advanced optimizations such as strength reduction, inlining, code motion, instruction combining, and sophisticated register allocation. TurboFanâ€™s design supports entering the pipeline very late, nearer to machine code, which bypasses many of the stages necessary for supporting JavaScript compilation. By design, transforming WebAssembly code into TurboFanâ€™s IR (including &lt;a href=&quot;https://en.wikipedia.org/wiki/Static_single_assignment_form&quot;&gt;&lt;em&gt;SSA-construction&lt;/em&gt;&lt;/a&gt;) in a straightforward single pass is very efficient, partially due to WebAssemblyâ€™s structured control flow. Yet the backend of the compilation process still consumes considerable time and memory.&lt;/p&gt;
&lt;h2 id=&quot;the-new-compilation-pipeline-(liftoff)&quot;&gt;The new compilation pipeline (Liftoff) &lt;a class=&quot;bookmark&quot; href=&quot;#the-new-compilation-pipeline-(liftoff)&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The goal of Liftoff is to reduce startup time for WebAssembly-based apps by generating code as fast as possible. Code quality is secondary, as hot code is eventually recompiled with TurboFan anyway. Liftoff avoids the time and memory overhead of constructing an IR and generates machine code in a single pass over the bytecode of a WebAssembly function.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/pipeline.svg&quot; alt=&quot;The Liftoff compilation pipeline is much simpler compared to the TurboFan compilation pipeline.&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;From the diagram above it is obvious that Liftoff should be able to generate code much faster than TurboFan since the pipeline only consists of two stages. In fact, the &lt;em&gt;function body decoder&lt;/em&gt; does a single pass over the raw WebAssembly bytes and interacts with the subsequent stage via callbacks, so &lt;em&gt;code generation&lt;/em&gt; is performed &lt;em&gt;while decoding and validating&lt;/em&gt; the function body. Together with WebAssemblyâ€™s &lt;em&gt;&lt;a href=&quot;https://v8.js.cn/blog/v8-release-65&quot;&gt;streaming APIs&lt;/a&gt;&lt;/em&gt;, this allows V8 to compile WebAssembly code to machine code while downloading over the network.&lt;/p&gt;
&lt;h3 id=&quot;code-generation-in-liftoff&quot;&gt;Code generation in Liftoff &lt;a class=&quot;bookmark&quot; href=&quot;#code-generation-in-liftoff&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Liftoff is a simple code generator, and fast. It performs only one pass over the opcodes of a function, generating code for each opcode, one at a time. For simple opcodes like arithmetics, this is often a single machine instruction, but can be more for others like calls. Liftoff maintains metadata about the operand stack in order to know where the inputs of each operation are currently stored. This &lt;em&gt;virtual stack&lt;/em&gt; exists only during compilation. WebAssemblyâ€™s structured control flow and validation rules guarantee that the location of these inputs can be statically determined. Thus an actual runtime stack onto which operands are pushed and popped is not necessary. During execution, each value on the virtual stack will either be held in a register or be spilled to the physical stack frame of that function. For small integer constants (generated by &lt;code&gt;i32.const&lt;/code&gt;), Liftoff only records the constantâ€™s value in the virtual stack and does not generate any code. Only when the constant is used by a subsequent operation, it is emitted or combined with the operation, for example by directly emitting a &lt;code&gt;addl &amp;lt;reg&amp;gt;, &amp;lt;const&amp;gt;&lt;/code&gt; instruction on x64. This avoids ever loading that constant into a register, resulting in better code.&lt;/p&gt;
&lt;p&gt;Letâ€™s go through a very simple function to see how Liftoff generates code for that.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/example-1.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;This example function takes two parameters and returns their sum. When Liftoff decodes the bytes of this function, it first begins by initializing its internal state for the local variables according to the calling convention for WebAssembly functions. For x64, V8â€™s calling convention passes the two parameters in the registers &lt;em&gt;rax&lt;/em&gt; and &lt;em&gt;rdx&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;For &lt;code&gt;get_local&lt;/code&gt; instructions, Liftoff does not generate any code, but instead just updates its internal state to reflect that these register values are now pushed on the virtual stack. The &lt;code&gt;i32.add&lt;/code&gt; instruction then pops the two registers and chooses a register for the result value. We  cannot use any of the input registers for the result, since both registers still appear on the stack for holding the local variables. Overwriting them would change the value returned by a later &lt;code&gt;get_local&lt;/code&gt; instruction. So Liftoff picks a free register, in this case &lt;em&gt;rcx&lt;/em&gt;, and produce the sum of &lt;em&gt;rax&lt;/em&gt; and &lt;em&gt;rdx&lt;/em&gt; into that register. &lt;em&gt;rcx&lt;/em&gt; is then pushed onto the virtual stack.&lt;/p&gt;
&lt;p&gt;After the &lt;code&gt;i32.add&lt;/code&gt; instruction, the function body is finished, so Liftoff must assemble the function return. As our example function has one return value, validation requires that there must be exactly one value on the virtual stack at the end of the function body. So Liftoff generates code that moves the return value held in &lt;em&gt;rcx&lt;/em&gt; into the proper return register &lt;em&gt;rax&lt;/em&gt; and then returns from the function.&lt;/p&gt;
&lt;p&gt;For the sake of simplicity, the example above does not contain any blocks (&lt;code&gt;if&lt;/code&gt;, &lt;code&gt;loop&lt;/code&gt; â€¦) or branches. Blocks in WebAssembly introduce control merges, since code can branch to any parent block, and if-blocks can be skipped. These merge points can be reached from different stack states. Following code, however, has to assume a specific stack state to generate code. Thus, Liftoff snapshots the current state of the virtual stack as the state which will be assumed for code following the new block (i.e. when returning to the &lt;em&gt;control level&lt;/em&gt; where we currently are). The new block will then continue with the currently active state, potentially changing where stack values or locals are stored: some might be spilled to the stack or held in other registers. When branching to another block or ending a block (which is the same as branching to the parent block), Liftoff must generate code that adapts the current state to the expected state at that point, such that the code emitted for the target we branch to finds the right values where it expects them. Validation guarantees that the height of the current virtual stack matches the height of the expected state, so Liftoff need only generate code to shuffle values between registers and/or the physical stack frame as shown below.&lt;/p&gt;
&lt;p&gt;Letâ€™s look at an example of that.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/example-2.svg&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;The example above assumes a virtual stack with two values on the operand stack. Before starting the new block, the top value on the virtual stack is popped as argument to the &lt;code&gt;if&lt;/code&gt; instruction. The remaining stack value needs to be put in another register, since it is currently shadowing the first parameter, but when branching back to this state we might need to hold two different values for the stack value and the parameter. In this case Liftoff chooses to deduplicate it into the &lt;em&gt;rcx&lt;/em&gt; register. This state is then snapshotted, and the active state is modified within the block. At the end of the block, we implicitly branch back to the parent block, so we merge the current state into the snapshot by moving register &lt;em&gt;rbx&lt;/em&gt; into &lt;em&gt;rcx&lt;/em&gt; and reloading register &lt;em&gt;rdx&lt;/em&gt; from the stack frame.&lt;/p&gt;
&lt;h3 id=&quot;tiering-up-from-liftoff-to-turbofan&quot;&gt;Tiering up from Liftoff to TurboFan &lt;a class=&quot;bookmark&quot; href=&quot;#tiering-up-from-liftoff-to-turbofan&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;With Liftoff and Turbofan, V8 now has two compilation tiers for WebAssembly: Liftoff as the baseline compiler for fast startup and TurboFan as optimizing compiler for maximum performance. This poses the question of how to combine the two compilers to provide the best overall user experience.&lt;/p&gt;
&lt;p&gt;For JavaScript, V8 uses the Ignition interpreter and the TurboFan compiler and employs a dynamic tier-up strategy. Each function is first executed in Ignition, and if the function becomes hot, TurboFan compiles it into highly-optimized machine code. A similar approach could also be used for Liftoff, but the tradeoffs are a bit different here:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;WebAssembly does not require type feedback to generate fast code. Where JavaScript greatly benefits from gathering type feedback, WebAssembly is statically typed, so the engine can generate optimized code right away.&lt;/li&gt;
&lt;li&gt;WebAssembly code should run &lt;em&gt;predictably&lt;/em&gt; fast, without a lengthy warm-up phase. One of the reasons applications target WebAssembly is to execute on the web &lt;em&gt;with predictable high performance&lt;/em&gt;. So we can neither tolerate running suboptimal code for too long, nor do we accept compilation pauses during execution.&lt;/li&gt;
&lt;li&gt;An important design goal of the Ignition interpreter for JavaScript is to reduce memory usage by not compiling functions at all. Yet we found that an interpreter for WebAssembly is far too slow to deliver on the goal of predictably fast performance. We did, in fact, build such an interpreter, but being 20Ã— or more slower than compiled code, it is only useful for debugging, regardless of how much memory it saves. Given this, the engine must store compiled code anyway; in the end it should store only the most compact and most efficient code, which is TurboFan optimized code.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;From these constraints we concluded that dynamic tier-up is not the right tradeoff for V8â€™s implementation of WebAssembly right now, since it would increase code size and reduce performance for an indeterminate time span. Instead, we chose a strategy of &lt;em&gt;eager tier-up&lt;/em&gt;. Immediately after Liftoff compilation of a module finished, the WebAssembly engine starts background threads to generate optimized code for the module. This allows V8 to start executing code quickly (after Liftoff finished), but still have the most performant TurboFan code available as early as possible.&lt;/p&gt;
&lt;p&gt;The picture below shows the trace of compiling and executing &lt;a href=&quot;https://s3.amazonaws.com/mozilla-games/ZenGarden/EpicZenGarden.html&quot;&gt;the EpicZenGarden benchmark&lt;/a&gt;. It shows that right after Liftoff compilation we can instantiate the WebAssembly module and start executing it. TurboFan compilation still takes several more seconds, so during that tier-up period the observed execution performance gradually increases since individual TurboFan functions are used as soon as they are finished.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/tierup-liftoff-turbofan.png&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;performance&quot;&gt;Performance &lt;a class=&quot;bookmark&quot; href=&quot;#performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Two metrics are interesting for evaluating the performance of the new Liftoff compiler. First we want to compare the compilation speed (i.e. time to generate code) with TurboFan. Second, we want to measure the performance of the generated code (i.e. execution speed). The first measure is the more interesting here, since the goal of Liftoff is to reduce startup time by generating code as quickly as possible. On the other hand, the performance of the generated code should still be pretty good since that code might still execute for several seconds or even minutes on low-end hardware.&lt;/p&gt;
&lt;h3 id=&quot;performance-of-generating-code&quot;&gt;Performance of generating code &lt;a class=&quot;bookmark&quot; href=&quot;#performance-of-generating-code&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For measuring the &lt;em&gt;compiler performance&lt;/em&gt; itself, we ran a number of benchmarks and measured the raw compilation time using tracing (see picture above). We run both benchmarks on an HP Z840 machine (2 x Intel Xeon E5-2690 @2.6GHz, 24 cores, 48 threads) and on a Macbook Pro (Intel Core i7-4980HQ @2.8GHz, 4 cores, 8 threads). Note that Chrome does currently not use more than 10 background threads, so most of the cores of the Z840 machine are unused.&lt;/p&gt;
&lt;p&gt;We execute three benchmarks:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://s3.amazonaws.com/mozilla-games/ZenGarden/EpicZenGarden.html&quot;&gt;&lt;strong&gt;EpicZenGarden&lt;/strong&gt;&lt;/a&gt;: The ZenGarden demo running on the Epic framework&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://webassembly.org/demo/&quot;&gt;&lt;strong&gt;Tanks!&lt;/strong&gt;&lt;/a&gt;: A demo of the Unity engine&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://web.autocad.com/&quot;&gt;&lt;strong&gt;AutoDesk&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://pspdfkit.com/webassembly-benchmark/&quot;&gt;&lt;strong&gt;PSPDFKit&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For each benchmark, we measure the raw compilation time using the tracing output as shown above. This number is more stable than any time reported by the benchmark itself, as it does not rely on a task being scheduled on the main thread and does not include unrelated work like creating the actual WebAssembly instance.&lt;/p&gt;
&lt;p&gt;The graphs below show the results of these benchmarks. Each benchmark was executed three times, and we report the average compilation time.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/performance-unity-macbook.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Code generation performance of Liftoff vs. TurboFan on a MacBook&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/performance-unity-z840.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Code generation performance of Liftoff vs. TurboFan on a Z840&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;As expected, the Liftoff compiler generates code much faster both on the high-end desktop workstation as well as on the MacBook. The speedup of Liftoff over TurboFan is even bigger on the less-capable MacBook hardware.&lt;/p&gt;
&lt;h3 id=&quot;performance-of-the-generated-code&quot;&gt;Performance of the generated code &lt;a class=&quot;bookmark&quot; href=&quot;#performance-of-the-generated-code&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Even though performance of the generated code is a secondary goal, we want to preserve user experience with high performance in the startup phase, as Liftoff code might execute for several seconds before TurboFan code is finished.&lt;/p&gt;
&lt;p&gt;For measuring Liftoff code performance, we turned off tier-up in order to measure pure Liftoff execution. In this setup, we execute two benchmarks:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Unity headless benchmarks&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This is a number of benchmarks running in the Unity framework. They are headless, hence can be executed in the d8 shell directly. Each benchmark reports a score, which is not necessarily proportional to the execution performance, but good enough to compare the performance.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https://pspdfkit.com/webassembly-benchmark/&quot;&gt;&lt;strong&gt;PSPDFKit&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This benchmark reports the time it takes to perform different actions on a pdf document and the time it takes to instantiate the WebAssembly module (including compilation).&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Just as before, we execute each benchmark three times and use the average of the three runs. Since the scale of the recorded numbers differs significantly between the benchmarks, we report the &lt;em&gt;relative performance of Liftoff vs. TurboFan&lt;/em&gt;. A value of &lt;em&gt;+30%&lt;/em&gt; means that Liftoff code runs 30% slower than TurboFan. Negative numbers indicate that Liftoff executes faster. Here are the results:&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/performance-unity-compile.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Liftoff Performance on Unity&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;On Unity, Liftoff code execute on average around 50% slower than TurboFan code on the desktop machine and 70% slower on the MacBook. Interestingly, there is one case (Mandelbrot Script) where Liftoff code outperforms TurboFan code. This is likely an outlier where, for example, the register allocator of TurboFan is doing poorly in a hot loop. We are investigating to see if TurboFan can be improved to handle this case better.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/liftoff/performance-pspdfkit-compile.svg&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Liftoff Performance on PSPDFKit&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;On the PSPDFKit benchmark, Liftoff code executes 18-54% slower than optimized code, while initialization improves significantly, as expected. These numbers show that for real-world code which also interacts with the browser via JavaScript calls, the performance loss of unoptimized code is generally lower than on more computation-intensive benchmarks.&lt;/p&gt;
&lt;p&gt;And again, note that for these numbers we turned off tier-up completely, so we only ever executed Liftoff code. In production configurations, Liftoff code will gradually be replaced by TurboFan code, such that the lower performance of Liftoff code lasts only for short period of time.&lt;/p&gt;
&lt;h2 id=&quot;future-work&quot;&gt;Future work &lt;a class=&quot;bookmark&quot; href=&quot;#future-work&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;After the initial launch of Liftoff, we are working to further improve startup time, reduce memory usage, and bring the benefits of Liftoff to more users. In particular, we are working on improving the following things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Port Liftoff to arm and arm64 to also use it on mobile devices.&lt;/strong&gt; Currently, Liftoff is only implemented for Intel platforms (32 and 64 bit), which mostly captures desktop use cases. In order to also reach mobile users, we will port Liftoff to more architectures.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Implement dynamic tier-up for mobile devices.&lt;/strong&gt; Since mobile devices tend to have much less memory available than desktop systems, we need to adapt our tiering strategy for these devices. Just recompiling all functions with TurboFan easily doubles the memory needed to hold all code, at least temporarily (until Liftoff code is discarded). Instead, we are experimenting with a combination of lazy compilation with Liftoff and dynamic tier-up of hot functions in TurboFan.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Improve performance of Liftoff code generation.&lt;/strong&gt; The first iteration of an implementation is rarely the best one. There are several things which can be tuned to speed up the compilation speed of Liftoff even more. This will gradually happen over the next releases.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Improve performance of Liftoff code.&lt;/strong&gt; Apart from the compiler itself, the size and speed of the generated code can also be improved. This will also happen gradually over the next releases.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion &lt;a class=&quot;bookmark&quot; href=&quot;#conclusion&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;V8 now contains Liftoff, a new baseline compiler for WebAssembly. Liftoff vastly reduces start-up time of WebAssembly applications with a simple and fast code generator. On desktop systems, V8 still reaches maximum peak performance by recompiling all code in the background using TurboFan. Liftoff is enabled by default in V8 v6.9 (Chrome 69), and can be controlled explicitly with the &lt;code&gt;--liftoff&lt;/code&gt;/&lt;code&gt;--no-liftoff&lt;/code&gt; and &lt;code&gt;chrome://flags/#enable-webassembly-baseline&lt;/code&gt; flags in each, respectively.&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>Embedded builtins</title>
    <link href="https://v8.js.cn/blog/embedded-builtins"/>
    <updated>2018-08-14T13:33:37+00:00</updated>
    <id>https://v8.js.cn/blog/embedded-builtins</id>
    <author>
      <name>Jakob Gruber (@schuay)</name>
    </author>
    <content type="html">&lt;p&gt;V8 built-in functions (builtins) consume memory in every instance of V8. The builtin count, average size, and the number of V8 instances per Chrome browser tab have been growing significantly. This blog post describes how we reduced the median V8 heap size per website by 19% over the past year.&lt;/p&gt;
&lt;h2 id=&quot;background&quot;&gt;Background &lt;a class=&quot;bookmark&quot; href=&quot;#background&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;V8 ships with an extensive library of JavaScript (JS) &lt;a href=&quot;https://v8.js.cn/docs/builtin-functions&quot;&gt;built-in functions&lt;/a&gt;. Many builtins are directly exposed to JS developers as functions installed on JS built-in objects, such as &lt;code&gt;RegExp.prototype.exec&lt;/code&gt; and &lt;code&gt;Array.prototype.sort&lt;/code&gt;; other builtins implement various internal functionality. Machine code for builtins is generated by V8â€™s own compiler, and is loaded onto the managed heap state for every V8 Isolate upon initialization. An Isolate represents an isolated instance of the V8 engine, and every browser tab in Chrome contains at least one Isolate. Every Isolate has its own managed heap, and thus its own copy of all builtins.&lt;/p&gt;
&lt;p&gt;Back in 2015, builtins were mostly implemented in self-hosted JS, native assembly, or in C++. They were fairly small, and creating a copy for every Isolate was less problematic.&lt;/p&gt;
&lt;p&gt;Much has changed in this space over the last years.&lt;/p&gt;
&lt;p&gt;In 2016, V8 &lt;a href=&quot;https://v8.js.cn/blog/speeding-up-regular-expressions&quot;&gt;began&lt;/a&gt; experimenting with builtins implemented in &lt;a href=&quot;https://v8.js.cn/blog/csa&quot;&gt;CodeStubAssembler&lt;/a&gt; (CSA). This turned out to both be convenient (platform-independent, readable) and to produce efficient code, so CSA builtins became ubiquitous. For a variety of reasons, CSA builtins tend to produce larger code, and the size of V8 builtins roughly tripled as more and more were ported to CSA. By mid-2017, their per-Isolate overhead had grown significantly and we started thinking about a systematic solution.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/snapshot-size.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;V8 snapshot size (including builtins) from 2015 until 2017&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;In late 2017, we implemented &lt;a href=&quot;https://v8.js.cn/blog/lazy-deserialization&quot;&gt;lazy builtin (and bytecode handler) deserialization&lt;/a&gt; as a first step. Our initial analysis showed that most sites used less than half of all builtins. With lazy deserialization, builtins are loaded on-demand, and unused builtins are never loaded into the Isolate. Lazy deserialization was shipped in Chrome 64 with promising memory savings. But: builtin memory overhead was still linear in the number of Isolates.&lt;/p&gt;
&lt;p&gt;Then, &lt;a href=&quot;https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html&quot;&gt;Spectre&lt;/a&gt; was disclosed, and Chrome ultimately turned on &lt;a href=&quot;https://security.googleblog.com/2018/07/mitigating-spectre-with-site-isolation.html&quot;&gt;site isolation&lt;/a&gt; to mitigate its effects. Site isolation limits a Chrome renderer process to documents from a single origin. Thus, with site isolation, many browsing tabs create more renderer processes and more V8 Isolates. Even though managing per-Isolate overhead has always been important, site isolation has made it even more so.&lt;/p&gt;
&lt;h2 id=&quot;embedded-builtins&quot;&gt;Embedded builtins &lt;a class=&quot;bookmark&quot; href=&quot;#embedded-builtins&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Our goal for this project was to completely eliminate per-Isolate builtin overhead.&lt;/p&gt;
&lt;p&gt;The idea behind it was simple. Conceptually, builtins are identical across Isolates, and are only bound to an Isolate because of implementation details. If we could make builtins truly isolate-independent, we could keep a single copy in memory and share them across all Isolates. And if we could make them process-independent, they could even be shared across processes.&lt;/p&gt;
&lt;p&gt;In practice, we faced several challenges. Generated builtin code was neither isolate- nor process-independent due to embedded pointers to isolate- and process-specific data. V8 had no concept of executing generated code located outside the managed heap. Builtins had to be shared across processes, ideally by reusing existing OS mechanisms. And finally (this turned out to be the long tail), performance must not noticeably regress.&lt;/p&gt;
&lt;p&gt;The following sections describe our solution in detail.&lt;/p&gt;
&lt;h3 id=&quot;isolate--and-process-independent-code&quot;&gt;Isolate- and process-independent code &lt;a class=&quot;bookmark&quot; href=&quot;#isolate--and-process-independent-code&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Builtins are generated by V8â€™s compiler internal pipeline, which embeds references to heap constants (located on the Isolateâ€™s managed heap), call targets (&lt;code&gt;Code&lt;/code&gt; objects, also on the managed heap), and to isolate- and process-specific addresses (e.g.: C runtime functions or a pointer to the Isolate itself, also called â€™external referencesâ€™) directly into the code. In x64 assembly, a load of such an object could look as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Load an embedded address into register rbx.
REX.W movq rbx,0x56526afd0f70
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;V8 has a moving garbage collector, and the location of the target object could change over time. Should the target be moved during collection, the GC updates the generated code to point at the new location.&lt;/p&gt;
&lt;p&gt;On x64 (and most other architectures), calls to other &lt;code&gt;Code&lt;/code&gt; objects use an efficient call instruction which specifies the call target by an offset from the current program counter (an interesting detail: V8 reserves its entire &lt;code&gt;CODE_SPACE&lt;/code&gt; on the managed heap at startup to ensure all possible Code objects remain within an addressable offset of each other). The relevant part of the calling sequence looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Call instruction located at [pc + &amp;lt;offset&amp;gt;].
call &amp;lt;offset&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/pc-relative-call.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;A pc-relative call&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Code objects themselves live on the managed heap and are movable. When they are moved, the GC updates the offset at all relevant call sites.&lt;/p&gt;
&lt;p&gt;In order to share builtins across processes, generated code must be immutable as well as isolate- and process-independent. Both instruction sequences above do not fulfill that requirement: they directly embed addresses in the code, and are patched at runtime by the GC.&lt;/p&gt;
&lt;p&gt;To address both issues, we introduced an indirection through a dedicated, so-called root register, which holds a pointer into a known location within the current Isolate.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/isolate-layout.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Isolate layout&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;V8â€™s &lt;code&gt;Isolate&lt;/code&gt; class contains the roots table, which itself contains pointers to root objects on the managed heap. The root register permanently holds the address of the roots table.&lt;/p&gt;
&lt;p&gt;The new, isolate- and process-independent way to load a root object thus becomes:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Load the constant address located at the given
// offset from roots.
REX.W movq rax,[kRootRegister + &amp;lt;offset&amp;gt;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Root heap constants can be loaded directly from the roots list as above. Other heap constants use an additional indirection through a global builtins constant pool, itself stored on the roots list:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Load the builtins constant pool, then the
// desired constant.
REX.W movq rax,[kRootRegister + &amp;lt;offset&amp;gt;]
REX.W movq rax,[rax + 0x1d7]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For &lt;code&gt;Code&lt;/code&gt; targets, we initially switched to a more involved calling sequence which loads the target &lt;code&gt;Code&lt;/code&gt; object from the global builtins constant pool as above, loads the target address into a register, and finally performs an indirect call.&lt;/p&gt;
&lt;p&gt;With these changes, generated code became isolate- and process-independent and we could begin working on sharing it between processes.&lt;/p&gt;
&lt;h2 id=&quot;sharing-across-processes&quot;&gt;Sharing across processes &lt;a class=&quot;bookmark&quot; href=&quot;#sharing-across-processes&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;We initially evaluated two alternatives. Builtins could either be shared by &lt;code&gt;mmap&lt;/code&gt;-ing a data blob file into memory; or, they could be embedded directly into the binary. We took the latter approach since it had the advantage that we would automatically reuse standard OS mechanisms to share memory across processes, and the change would not require additional logic by V8 embedders such as Chrome. We were confident in this approach since &lt;a href=&quot;https://www.youtube.com/watch?v=lqE4u8s8Iik&quot;&gt;Dartâ€™s AOT compilation&lt;/a&gt; had already successfully binary-embedded generated code.&lt;/p&gt;
&lt;p&gt;An executable binary file is split into several sections. For example, an ELF binary contains data in the &lt;code&gt;.data&lt;/code&gt; (initialized data), &lt;code&gt;.ro_data&lt;/code&gt; (initialized read-only data), and &lt;code&gt;.bss&lt;/code&gt; (uninitialized data) sections, while native executable code is placed in &lt;code&gt;.text&lt;/code&gt;. Our goal was to pack the builtins code into the &lt;code&gt;.text&lt;/code&gt; section alongside native code.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/binary-format.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Sections of an executable binary file&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;This was done by introducing a new build step that used V8â€™s internal compiler pipeline to generate native code for all builtins and output their contents in &lt;code&gt;embedded.cc&lt;/code&gt;. This file is then compiled into the final V8 binary.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/build-process.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;The (simplified) V8 embedded build process&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;The &lt;code&gt;embedded.cc&lt;/code&gt; file itself contains both metadata and generated builtins machine code as a series of &lt;code&gt;.byte&lt;/code&gt; directives that instruct the C++ compiler (in our case, clang or gcc) to place the specified byte sequence directly into the output object file (and later the executable).&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Information about embedded builtins are included in
// a metadata table.
V8_EMBEDDED_TEXT_HEADER(v8_Default_embedded_blob_)
__asm__(&amp;quot;.byte 0x65,0x6d,0xcd,0x37,0xa8,0x1b,0x25,0x7e\n&amp;quot;
[snip metadata]

// Followed by the generated machine code.
__asm__(V8_ASM_LABEL(&amp;quot;Builtins_RecordWrite&amp;quot;));
__asm__(&amp;quot;.byte 0x55,0x48,0x89,0xe5,0x6a,0x18,0x48,0x83\n&amp;quot;
[snip builtins code]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Contents of the &lt;code&gt;.text&lt;/code&gt; section are mapped into read-only executable memory at runtime, and the operating system will share memory across processes as long as it contains only position-independent code without relocatable symbols. This is exactly what we wanted.&lt;/p&gt;
&lt;p&gt;But V8â€™s &lt;code&gt;Code&lt;/code&gt; objects consist not only of the instruction stream, but also have various pieces of (sometimes isolate-dependent) metadata. Normal run-of-the-mill &lt;code&gt;Code&lt;/code&gt; objects pack both metadata and the instruction stream into a variable-sized &lt;code&gt;Code&lt;/code&gt; object that is located on the managed heap.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/code-on-heap.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;On-heap &lt;code&gt;Code&lt;/code&gt; object layout&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;As weâ€™ve seen, embedded builtins have their native instruction stream located outside the managed heap, embedded into the &lt;code&gt;.text&lt;/code&gt; section. To preserve their metadata, each embedded builtin also has a small associated &lt;code&gt;Code&lt;/code&gt; object on the managed heap, called the &lt;em&gt;off-heap trampoline&lt;/em&gt;. Metadata is stored on the trampoline as for standard &lt;code&gt;Code&lt;/code&gt; objects, while the inlined instruction stream simply contains a short sequence which loads the address of the embedded instructions and jumps there.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/code-off-heap.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Off-heap &lt;code&gt;Code&lt;/code&gt; object layout&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;The trampoline allows V8 to handle all &lt;code&gt;Code&lt;/code&gt; objects uniformly. For most purposes, it is irrelevant whether the given &lt;code&gt;Code&lt;/code&gt; object refers to standard code on the managed heap or to an embedded builtin.&lt;/p&gt;
&lt;h3 id=&quot;optimizing-for-performance&quot;&gt;Optimizing for performance &lt;a class=&quot;bookmark&quot; href=&quot;#optimizing-for-performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;With the solution described in previous sections, embedded builtins were essentially feature-complete, but benchmarks showed that they came with significant slowdowns. For instance, our initial solution regressed &lt;a href=&quot;https://v8.js.cn/blog/speedometer-2&quot;&gt;Speedometer 2.0&lt;/a&gt; by more than 5% overall.&lt;/p&gt;
&lt;p&gt;We began to hunt for optimization opportunities, and identified major sources of slowdowns. The generated code was slower due to frequent indirections taken to access isolate- and process-dependent objects. Root constants were loaded from the root list (1 indirection), other heap constants from the global builtins constant pool (2 indirections), and external references additionally had to be unpacked from within a heap object (3 indirections). The worst offender was our new calling sequence, which had to load the trampoline Code object, call it, only to then jump to the target address. Finally, it appears that calls between the managed heap and binary-embedded code were inherently slower, possibly due to the long jump distance interfering with the CPUâ€™s branch prediction.&lt;/p&gt;
&lt;p&gt;Our work thus concentrated on 1. reducing indirections, and 2. improving the builtin calling sequence. To address the former, we altered the Isolate object layout to turn most object loads into a single root-relative load. The global builtins constant pool still exists, but only contains infrequently-accessed objects.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/isolate-layout-optimized.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Optimized Isolate layout&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Calling sequences were significantly improved on two fronts. Builtin-to-builtin calls were converted into a single pc-relative call instruction. This was not possible for runtime-generated JIT code since the pc-relative offset could exceed the maximal 32-bit value. There, we inlined the off-heap trampoline into all call sites, reducing the calling sequence from 6 to just 2 instructions.&lt;/p&gt;
&lt;p&gt;With these optimizations, we were able to limit regressions on Speedometer 2.0 to roughly 0.5%.&lt;/p&gt;
&lt;h1 id=&quot;results&quot;&gt;Results &lt;a class=&quot;bookmark&quot; href=&quot;#results&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;We evaluated the impact of embedded builtins on x64 over the top 10k most popular websites, and compared against both lazy- and eager deserialization (described above).&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/embedded-builtins/results.png&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;V8 heap size reduction vs. eager and lazy deserialization&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Whereas previously Chrome would ship with a memory-mapped snapshot that weâ€™d deserialize on each Isolate, now the snapshot is replaced by embedded builtins that are still memory mapped but do not need to be deserialized. The cost for builtins used to be &lt;code&gt;c*(1 + n)&lt;/code&gt; where &lt;code&gt;n&lt;/code&gt; is the number of Isolates and &lt;code&gt;c&lt;/code&gt; the memory cost of all builtins, whereas now itâ€™s just &lt;code&gt;c * 1&lt;/code&gt; (in practice, a small amount of per-Isolate overhead also remains for off heap trampolines).&lt;/p&gt;
&lt;p&gt;Compared against eager deserialization, we reduced the median V8 heap size by 19%. The median Chrome renderer process size per site has decreased by 4%. In absolute numbers, the 50th percentile saves 1.9 MB, the 30th percentile saves 3.4 MB, and the 10th percentile saves 6.5 MB per site.&lt;/p&gt;
&lt;p&gt;Significant additional memory savings are expected once bytecode handlers are also binary-embedded.&lt;/p&gt;
&lt;p&gt;Embedded builtins are rolling out on x64 in Chrome 69, and mobile platforms will follow in Chrome 70. Support for ia32 is expected to be released in late 2018.&lt;/p&gt;
&lt;p&gt;Note: All diagrams were generated using Vyacheslav Egorovâ€™s awesome &lt;a href=&quot;https://mrale.ph/blog/2012/11/25/shaky-diagramming.html&quot;&gt;Shaky Diagramming&lt;/a&gt; tool.&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>V8 release v6.9</title>
    <link href="https://v8.js.cn/blog/v8-release-69"/>
    <updated>2018-08-07T13:33:37+00:00</updated>
    <id>https://v8.js.cn/blog/v8-release-69</id>
    <author>
      <name>the V8 team</name>
    </author>
    <content type="html">&lt;p&gt;Every six weeks, we create a new branch of V8 as part of our &lt;a href=&quot;https://v8.js.cn/docs/release-process&quot;&gt;release process&lt;/a&gt;. Each version is branched from V8â€™s Git master immediately before a Chrome Beta milestone. Today weâ€™re pleased to announce our newest branch, &lt;a href=&quot;https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/6.9&quot;&gt;V8 version 6.9&lt;/a&gt;, which is in beta until its release in coordination with Chrome 69 Stable in several weeks. V8 v6.9 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.&lt;/p&gt;
&lt;h2 id=&quot;memory-savings-through-embedded-built-ins&quot;&gt;Memory savings through embedded built-ins &lt;a class=&quot;bookmark&quot; href=&quot;#memory-savings-through-embedded-built-ins&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;V8 ships with an extensive library of built-in functions. Examples are methods on built-in objects such as &lt;code&gt;Array.prototype.sort&lt;/code&gt; and &lt;code&gt;RegExp.prototype.exec&lt;/code&gt;, but also a wide range of internal functionality. Because their generation takes a long time, built-in functions are compiled at build-time and serialized into a &lt;a href=&quot;https://v8.js.cn/blog/custom-startup-snapshots&quot;&gt;snapshot&lt;/a&gt;, which is later deserialized at runtime to create the initial JavaScript heap state.&lt;/p&gt;
&lt;p&gt;Built-in functions currently consume 700 KB in each Isolate (an Isolate roughly corresponds to a browser tab in Chrome). This is quite wasteful, and last year we began working on reducing this overhead. In V8 v6.4, we shipped &lt;a href=&quot;https://v8.js.cn/blog/lazy-deserialization&quot;&gt;lazy deserialization&lt;/a&gt;, ensuring that each Isolate only pays for the built-ins that it actually needs (but each Isolate still had its own copy).&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;Embedded built-ins&lt;/a&gt; go one step further. An embedded built-in is shared by all Isolates, and embedded into the binary itself instead of copied onto the JavaScript heap. This means that built-ins exist in memory only once regardless of how many Isolates are running, an especially useful property now that &lt;a href=&quot;https://developers.google.com/web/updates/2018/07/site-isolation&quot;&gt;Site Isolation&lt;/a&gt; has been enabled by default. With embedded built-ins, weâ€™ve seen a median &lt;em&gt;9% reduction of the V8 heap size&lt;/em&gt; over the top 10k websites on x64. Of these sites, 50% save at least 1.2 MB, 30% save at least 2.1 MB, and 10% save 3.7 MB or more.&lt;/p&gt;
&lt;p&gt;V8 v6.9 ships with support for embedded built-ins on x64 platforms. Other platforms will follow soon in upcoming releases. For more details, see our &lt;a href=&quot;https://v8.js.cn/blog/embedded-builtins&quot;&gt;dedicated blog post&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;performance&quot;&gt;Performance &lt;a class=&quot;bookmark&quot; href=&quot;#performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;liftoff%2C-webassembly%E2%80%99s-new-first-tier-compiler&quot;&gt;Liftoff, WebAssemblyâ€™s new first-tier compiler &lt;a class=&quot;bookmark&quot; href=&quot;#liftoff%2C-webassembly%E2%80%99s-new-first-tier-compiler&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;WebAssembly got a new baseline compiler for much faster startup of complex websites with big WebAssembly modules (such as Google Earth and AutoCAD). Depending on the hardware we are seeing speedups of more than 10Ã—. For more details, refer to &lt;a href=&quot;https://v8.js.cn/blog/liftoff&quot;&gt;the detailed Liftoff blog post&lt;/a&gt;.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-liftoff.svg&quot; width=&quot;256&quot; height=&quot;256&quot; alt=&quot;&quot;&gt;
  &lt;figcaption&gt;Logo for Liftoff, V8â€™s baseline compiler for WebAssembly&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;faster-dataview-operations&quot;&gt;Faster &lt;code&gt;DataView&lt;/code&gt; operations &lt;a class=&quot;bookmark&quot; href=&quot;#faster-dataview-operations&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://tc39.github.io/ecma262/#sec-dataview-objects&quot;&gt;&lt;code&gt;DataView&lt;/code&gt;&lt;/a&gt; methods have been reimplemented in V8 Torque, which spares a costly call to C++ compared to the former runtime implementation. Moreover, we now inline calls to &lt;code&gt;DataView&lt;/code&gt; methods when compiling JavaScript code in TurboFan, resulting in even better peak performance for hot code. Using &lt;code&gt;DataView&lt;/code&gt;s is now as efficient as using &lt;code&gt;TypedArray&lt;/code&gt;s, finally making &lt;code&gt;DataView&lt;/code&gt;s a viable choice in performance-critical situations. Weâ€™ll be covering this in more detail in an upcoming blog post about &lt;code&gt;DataView&lt;/code&gt;s, so stay tuned!&lt;/p&gt;
&lt;h3 id=&quot;faster-processing-of-weakmaps-during-garbage-collection&quot;&gt;Faster processing of &lt;code&gt;WeakMap&lt;/code&gt;s during garbage collection &lt;a class=&quot;bookmark&quot; href=&quot;#faster-processing-of-weakmaps-during-garbage-collection&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;V8 v6.9 reduces Mark-Compact garbage collection pause times by improving &lt;code&gt;WeakMap&lt;/code&gt; processing. Concurrent and incremental marking are now able to process &lt;code&gt;WeakMap&lt;/code&gt;s, whereas previously all this work was done in the final atomic pause of Mark-Compact GC. Since not all work can be moved outside of the pause, the GC now also does more work in parallel to further reduce pause times. These optimizations essentially halved the average pause time for Mark-Compact GCs in &lt;a href=&quot;https://github.com/v8/web-tooling-benchmark&quot;&gt;the Web Tooling Benchmark&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;WeakMap&lt;/code&gt; processing uses a fixed-point iteration algorithm that can degrade to quadratic runtime behavior in certain cases. With the new release, V8 is now able to switch to another algorithm that is guaranteed to finish in linear time if the GC does not finish within a certain number of iterations. Previously, worst-case examples could be constructed that took the GC a few seconds to finish even with a relatively small heap, while the linear algorithm finishes within a few milliseconds.&lt;/p&gt;
&lt;h2 id=&quot;v8-api&quot;&gt;V8 API &lt;a class=&quot;bookmark&quot; href=&quot;#v8-api&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Please use &lt;code&gt;git log branch-heads/6.8..branch-heads/6.9 include/v8.h&lt;/code&gt; to get a list of the API changes.&lt;/p&gt;
&lt;p&gt;Developers with an &lt;a href=&quot;https://v8.js.cn/docs/source-code#using-git&quot;&gt;active V8 checkout&lt;/a&gt; can use &lt;code&gt;git checkout -b 6.9 -t branch-heads/6.9&lt;/code&gt; to experiment with the new features in V8 v6.9. Alternatively you can &lt;a href=&quot;https://www.google.com/chrome/browser/beta.html&quot;&gt;subscribe to Chromeâ€™s Beta channel&lt;/a&gt; and try the new features out yourself soon.&lt;/p&gt;
</content>
  </entry>
  
  <entry>
    <title>V8 release v6.8</title>
    <link href="https://v8.js.cn/blog/v8-release-68"/>
    <updated>2018-06-21T13:33:37+00:00</updated>
    <id>https://v8.js.cn/blog/v8-release-68</id>
    <author>
      <name>the V8 team</name>
    </author>
    <content type="html">&lt;p&gt;Every six weeks, we create a new branch of V8 as part of our &lt;a href=&quot;https://v8.js.cn/docs/release-process&quot;&gt;release process&lt;/a&gt;. Each version is branched from V8â€™s Git master immediately before a Chrome Beta milestone. Today weâ€™re pleased to announce our newest branch, &lt;a href=&quot;https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/6.8&quot;&gt;V8 version 6.8&lt;/a&gt;, which is in beta until its release in coordination with Chrome 68 Stable in several weeks. V8 v6.8 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.&lt;/p&gt;
&lt;h2 id=&quot;memory&quot;&gt;Memory &lt;a class=&quot;bookmark&quot; href=&quot;#memory&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;JavaScript functions unnecessarily kept outer functions and their metadata (known as &lt;code&gt;SharedFunctionInfo&lt;/code&gt; or &lt;code&gt;SFI&lt;/code&gt;) alive. Especially in function-heavy code that relies on short-lived IIFEs, this could lead to spurious memory leaks. Before this change, an active &lt;code&gt;Context&lt;/code&gt; (i.e. an on-heap representation of a function activation) kept the &lt;code&gt;SFI&lt;/code&gt; alive of the function that created the context:&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-release-68/context-jsfunction-before.png&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;By letting the &lt;code&gt;Context&lt;/code&gt; point to a &lt;code&gt;ScopeInfo&lt;/code&gt; object which contains the stripped-down information necessary for debugging, we can break the dependency on the &lt;code&gt;SFI&lt;/code&gt;.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-release-68/context-jsfunction-after.png&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;Weâ€™ve already observed 3% V8 memory improvements on mobile devices over a set of top 10 pages.&lt;/p&gt;
&lt;p&gt;In parallel we have reduced the memory consumption of &lt;code&gt;SFI&lt;/code&gt;s themselves, removing unnecessary fields or compressing them where possible, and decreased their size by ~25%, with further reductions coming in future releases. Weâ€™ve observed &lt;code&gt;SFI&lt;/code&gt;s taking up 2â€“6% of V8 memory on typical websites even after detaching them from the context, so you should see memory improvements on code with a large number of functions.&lt;/p&gt;
&lt;h2 id=&quot;performance&quot;&gt;Performance &lt;a class=&quot;bookmark&quot; href=&quot;#performance&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;array-destructuring-improvements&quot;&gt;Array destructuring improvements &lt;a class=&quot;bookmark&quot; href=&quot;#array-destructuring-improvements&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The optimizing compiler did not generate ideal code for array destructuring. For example, swapping variables using &lt;code&gt;[a, b] = [b, a]&lt;/code&gt; used to be twice as slow as &lt;code&gt;const tmp = a; a = b; b = tmp&lt;/code&gt;. Once we unblocked escape analysis to eliminate all temporary allocation, array destructuring with a temporary array is as fast as a sequence of assignments.&lt;/p&gt;
&lt;h3 id=&quot;object.assign-improvements&quot;&gt;&lt;code&gt;Object.assign&lt;/code&gt; improvements &lt;a class=&quot;bookmark&quot; href=&quot;#object.assign-improvements&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;So far &lt;code&gt;Object.assign&lt;/code&gt; had a fast path written in C++. That meant that the JavaScript-to-C++ boundary had to be crossed for each &lt;code&gt;Object.assign&lt;/code&gt; call. An obvious way to improve the builtin performance was to implement a fast path on the JavaScript side. We had two options: either implement it as an native JS builtin (which would come with some unnecessary overhead in this case), or implement it &lt;a href=&quot;https://v8.js.cn/blog/csa&quot;&gt;using CodeStubAssembler technology&lt;/a&gt; (which provides more flexibility). We went with the latter solution. The new implementation of &lt;code&gt;Object.assign&lt;/code&gt; improves the score of &lt;a href=&quot;https://chromeperf.appspot.com/report?sid=d9ea9a2ae7cd141263fde07ea90da835cf28f5c87f17b53ba801d4ac30979558&amp;amp;start_rev=550155&amp;amp;end_rev=552590&quot;&gt;Speedometer2/React-Redux by about 15%, improving the total Speedometer 2 score by 1.5%&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;typedarray.prototype.sort-improvements&quot;&gt;&lt;code&gt;TypedArray.prototype.sort&lt;/code&gt; improvements &lt;a class=&quot;bookmark&quot; href=&quot;#typedarray.prototype.sort-improvements&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;TypedArray.prototype.sort&lt;/code&gt; has two paths: a fast path, used when the user does not provide a comparison function, and a slow path for everything else. Until now, the slow path reused the implementation for &lt;code&gt;Array.prototype.sort&lt;/code&gt;, which does a lot more than is necessary for sorting &lt;code&gt;TypedArray&lt;/code&gt;s. V8 v6.8 replaces the slow path with an implementation in &lt;a href=&quot;https://v8.js.cn/blog/csa&quot;&gt;CodeStubAssembler&lt;/a&gt;. (Not directly CodeStubAssembler but a domain-specific language that is built on top of CodeStubAssembler).&lt;/p&gt;
&lt;p&gt;Performance for sorting &lt;code&gt;TypedArray&lt;/code&gt;s without a comparison function stays the same while there is a speedup of up to 2.5Ã— when sorting using a comparison function.&lt;/p&gt;
&lt;figure&gt;
  &lt;img src=&quot;https://v8.js.cn/_img/v8-release-68/typedarray-sort.png&quot; alt=&quot;&quot;&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;webassembly&quot;&gt;WebAssembly &lt;a class=&quot;bookmark&quot; href=&quot;#webassembly&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In V8 v6.8 you can start using &lt;a href=&quot;https://docs.google.com/document/d/17y4kxuHFrVxAiuCP_FFtFA2HP5sNPsCD10KEx17Hz6M/edit&quot;&gt;trap-based bounds checking&lt;/a&gt; on Linux x64 platforms. This memory management optimization considerably improves WebAssemblyâ€™s execution speed. Itâ€™s already used in Chrome 68, and in the future more platforms will be supported incrementally.&lt;/p&gt;
&lt;h2 id=&quot;v8-api&quot;&gt;V8 API &lt;a class=&quot;bookmark&quot; href=&quot;#v8-api&quot; aria-hidden=&quot;true&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Please use &lt;code&gt;git log branch-heads/6.7..branch-heads/6.8 include/v8.h&lt;/code&gt; to get a list of the API changes.&lt;/p&gt;
&lt;p&gt;Developers with an &lt;a href=&quot;https://v8.js.cn/docs/source-code#using-git&quot;&gt;active V8 checkout&lt;/a&gt; can use &lt;code&gt;git checkout -b 6.8 -t branch-heads/6.8&lt;/code&gt; to experiment with the new features in V8 v6.8. Alternatively you can &lt;a href=&quot;https://www.google.com/chrome/browser/beta.html&quot;&gt;subscribe to Chromeâ€™s Beta channel&lt;/a&gt; and try the new features out yourself soon.&lt;/p&gt;
</content>
  </entry>
</feed>
